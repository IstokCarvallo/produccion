$PBExportHeader$w_info_guia_despacho_archivo_saam.srw
forward
global type w_info_guia_despacho_archivo_saam from w_para_informes
end type
type st_1 from statictext within w_info_guia_despacho_archivo_saam
end type
type st_2 from statictext within w_info_guia_despacho_archivo_saam
end type
type st_6 from statictext within w_info_guia_despacho_archivo_saam
end type
type em_nroguia from editmask within w_info_guia_despacho_archivo_saam
end type
type gb_3 from groupbox within w_info_guia_despacho_archivo_saam
end type
type cbx_1 from checkbox within w_info_guia_despacho_archivo_saam
end type
type cbx_2 from checkbox within w_info_guia_despacho_archivo_saam
end type
type cbx_3 from checkbox within w_info_guia_despacho_archivo_saam
end type
type cbx_4 from checkbox within w_info_guia_despacho_archivo_saam
end type
type st_3 from statictext within w_info_guia_despacho_archivo_saam
end type
type st_5 from statictext within w_info_guia_despacho_archivo_saam
end type
type st_7 from statictext within w_info_guia_despacho_archivo_saam
end type
type st_8 from statictext within w_info_guia_despacho_archivo_saam
end type
type em_recibidor from editmask within w_info_guia_despacho_archivo_saam
end type
type em_rut from editmask within w_info_guia_despacho_archivo_saam
end type
type em_direccion from editmask within w_info_guia_despacho_archivo_saam
end type
type cbx_5 from checkbox within w_info_guia_despacho_archivo_saam
end type
type st_9 from statictext within w_info_guia_despacho_archivo_saam
end type
type em_observa from editmask within w_info_guia_despacho_archivo_saam
end type
type dw_guia from datawindow within w_info_guia_despacho_archivo_saam
end type
type cbx_6 from checkbox within w_info_guia_despacho_archivo_saam
end type
type cbx_7 from checkbox within w_info_guia_despacho_archivo_saam
end type
type cbx_8 from checkbox within w_info_guia_despacho_archivo_saam
end type
type st_13 from statictext within w_info_guia_despacho_archivo_saam
end type
type em_nomdespachador from editmask within w_info_guia_despacho_archivo_saam
end type
type st_10 from statictext within w_info_guia_despacho_archivo_saam
end type
type em_tipomv from editmask within w_info_guia_despacho_archivo_saam
end type
type em_puerto from editmask within w_info_guia_despacho_archivo_saam
end type
type em_destino from editmask within w_info_guia_despacho_archivo_saam
end type
type st_11 from statictext within w_info_guia_despacho_archivo_saam
end type
type st_12 from statictext within w_info_guia_despacho_archivo_saam
end type
type st_14 from statictext within w_info_guia_despacho_archivo_saam
end type
type em_nominspector from editmask within w_info_guia_despacho_archivo_saam
end type
type cbx_frio from checkbox within w_info_guia_despacho_archivo_saam
end type
type gb_4 from groupbox within w_info_guia_despacho_archivo_saam
end type
type st_4 from statictext within w_info_guia_despacho_archivo_saam
end type
type cbx_id from checkbox within w_info_guia_despacho_archivo_saam
end type
type em_glosaespecial from editmask within w_info_guia_despacho_archivo_saam
end type
type st_15 from statictext within w_info_guia_despacho_archivo_saam
end type
type cbx_sdp from checkbox within w_info_guia_despacho_archivo_saam
end type
type mle_condicion from multilineedit within w_info_guia_despacho_archivo_saam
end type
type st_22 from statictext within w_info_guia_despacho_archivo_saam
end type
type st_16 from statictext within w_info_guia_despacho_archivo_saam
end type
type cbx_archivo from checkbox within w_info_guia_despacho_archivo_saam
end type
type cbx_resumen from checkbox within w_info_guia_despacho_archivo_saam
end type
type st_17 from statictext within w_info_guia_despacho_archivo_saam
end type
type em_numsellos from editmask within w_info_guia_despacho_archivo_saam
end type
type st_18 from statictext within w_info_guia_despacho_archivo_saam
end type
type em_ubisellos from editmask within w_info_guia_despacho_archivo_saam
end type
type dw_3 from datawindow within w_info_guia_despacho_archivo_saam
end type
type em_cansellos from editmask within w_info_guia_despacho_archivo_saam
end type
type cbx_valores from checkbox within w_info_guia_despacho_archivo_saam
end type
type st_19 from statictext within w_info_guia_despacho_archivo_saam
end type
type em_ciudad from editmask within w_info_guia_despacho_archivo_saam
end type
type cbx_csg from checkbox within w_info_guia_despacho_archivo_saam
end type
type dw_4 from datawindow within w_info_guia_despacho_archivo_saam
end type
type dw_5 from datawindow within w_info_guia_despacho_archivo_saam
end type
type dw_6 from datawindow within w_info_guia_despacho_archivo_saam
end type
type dw_7 from datawindow within w_info_guia_despacho_archivo_saam
end type
type dw_8 from datawindow within w_info_guia_despacho_archivo_saam
end type
type dw_tipopallet from datawindow within w_info_guia_despacho_archivo_saam
end type
type dw_etiqueta from datawindow within w_info_guia_despacho_archivo_saam
end type
type pb_imprime from picturebutton within w_info_guia_despacho_archivo_saam
end type
type gb_1 from groupbox within w_info_guia_despacho_archivo_saam
end type
type st_20 from statictext within w_info_guia_despacho_archivo_saam
end type
type uo_selcliente from uo_seleccion_clientesprod within w_info_guia_despacho_archivo_saam
end type
type uo_selplanta from uo_seleccion_plantas within w_info_guia_despacho_archivo_saam
end type
type cb_rossi from commandbutton within w_info_guia_despacho_archivo_saam
end type
type dw_error from uo_dw within w_info_guia_despacho_archivo_saam
end type
type cb_1 from commandbutton within w_info_guia_despacho_archivo_saam
end type
type dw_embarcador from datawindow within w_info_guia_despacho_archivo_saam
end type
end forward

global type w_info_guia_despacho_archivo_saam from w_para_informes
integer x = 14
integer y = 32
integer width = 2967
integer height = 2532
string title = "Módulo de Despacho"
boolean minbox = false
boolean maxbox = false
boolean resizable = false
windowtype windowtype = response!
string icon = "AppIcon!"
st_1 st_1
st_2 st_2
st_6 st_6
em_nroguia em_nroguia
gb_3 gb_3
cbx_1 cbx_1
cbx_2 cbx_2
cbx_3 cbx_3
cbx_4 cbx_4
st_3 st_3
st_5 st_5
st_7 st_7
st_8 st_8
em_recibidor em_recibidor
em_rut em_rut
em_direccion em_direccion
cbx_5 cbx_5
st_9 st_9
em_observa em_observa
dw_guia dw_guia
cbx_6 cbx_6
cbx_7 cbx_7
cbx_8 cbx_8
st_13 st_13
em_nomdespachador em_nomdespachador
st_10 st_10
em_tipomv em_tipomv
em_puerto em_puerto
em_destino em_destino
st_11 st_11
st_12 st_12
st_14 st_14
em_nominspector em_nominspector
cbx_frio cbx_frio
gb_4 gb_4
st_4 st_4
cbx_id cbx_id
em_glosaespecial em_glosaespecial
st_15 st_15
cbx_sdp cbx_sdp
mle_condicion mle_condicion
st_22 st_22
st_16 st_16
cbx_archivo cbx_archivo
cbx_resumen cbx_resumen
st_17 st_17
em_numsellos em_numsellos
st_18 st_18
em_ubisellos em_ubisellos
dw_3 dw_3
em_cansellos em_cansellos
cbx_valores cbx_valores
st_19 st_19
em_ciudad em_ciudad
cbx_csg cbx_csg
dw_4 dw_4
dw_5 dw_5
dw_6 dw_6
dw_7 dw_7
dw_8 dw_8
dw_tipopallet dw_tipopallet
dw_etiqueta dw_etiqueta
pb_imprime pb_imprime
gb_1 gb_1
st_20 st_20
uo_selcliente uo_selcliente
uo_selplanta uo_selplanta
cb_rossi cb_rossi
dw_error dw_error
cb_1 cb_1
dw_embarcador dw_embarcador
end type
global w_info_guia_despacho_archivo_saam w_info_guia_despacho_archivo_saam

type prototypes
FUNCTION long ShellExecuteW(uint ihwnd,string lpszOp,string lpszFile,string lpszParams, string lpszDir,int wShowCmd ) LIBRARY "Shell32.dll"
end prototypes

type variables
str_busqueda 	istr_busq
str_mant			istr_Mant

CONSTANT String SEPARADOR = '/'

Integer	ii_tipo, ii_condicion, ii_tipoemb, ii_especie, ii_controlcorreo, ii_controlws, ii_controlsaam, ii_var, ii_prod, ii_cal, ii_cli, ii_pakrot
String		is_report, is_Recibidor, is_Direccion, is_Rut, is_archivo, is_asunto, is_tipopla, is_ciudad, is_embarque, is_correosaampuerto, &
			is_parteemb, is_archivoguias, is_Archivo1
Long		il_despacho, al_planilla

w_informes_guia					vinf1
w_informes_guia_archivo 		vinf2

SoapConnection 	conn
cabeceraguia		istr_cabeceraguia

uo_Puertos				iuo_Puertos
uo_Embalajes			iuo_Embalaje
uo_Envases				iuo_Envase
uo_EmbarquesProd	iuo_Embarques
uo_Embarcador		iuo_Embarcador
uo_Plantadesp			iuo_Planta
uo_GuiaDespacho		iuo_Guia
uo_Despachos			iuo_Despacho
uo_Mail					iuo_Mail
end variables

forward prototypes
public function boolean existeguia (long al_guia)
public subroutine enviamail ()
public function boolean valida_datos ()
public function boolean obtiene_condicion (integer ai_cliente, integer ai_planta, long al_pallet)
public function boolean existearchivo (integer li_cliente, integer li_planta, long ll_guia, long al_planillas, string as_tipoplanilla, string as_instructivo)
public function boolean existeoperacion (string operacion)
public function boolean wf_actualiza_db (boolean borrando)
protected function integer despacho (integer li_cliente, integer li_planta, long ll_guia)
public function boolean validadespacho (integer li_cliente, integer li_planta, long ll_guia)
public subroutine enviaguiasaam ()
protected function boolean wf_trazabilidad (integer cliente, integer planta, long numero)
public subroutine wf_generaguia_ws ()
public subroutine wf_generaarchivo ()
public subroutine wf_enviamailarchivo ()
end prototypes

public function boolean existeguia (long al_guia);Integer	li_Tipova, li_tipoembq, li_embc_codigo, li_tecnic, li_cansel, li_consol, li_plades
Date		ld_fecha
String		ls_Embarque, ls_puerto, ls_destino, ls_contraparte, ls_numsel, ls_ubisel
Long		ll_fila, ll_fila1, ll_contpal, ll_cont

is_Recibidor	= ''
is_Direccion	= ''
is_Rut			= ''

If al_guia <> 0 OR uo_SelPlanta.Codigo = 0 Then
	SELECT defe_tiposa,defe_numero,defe_especi,defe_consol,defe_plades
		INTO	:li_tipoembq,:il_despacho,:ii_especie,:li_consol,:li_plades
		FROM	dbo.DESPAFRIGOEN 
		WHERE	plde_codigo =	:uo_SelPlanta.Codigo
		AND	clie_codigo	=	:uo_SelCliente.Codigo
		AND	defe_guides	=	:al_guia;
		
		iuo_Despacho.of_ExisteGuia(uo_SelCliente.Codigo, uo_SelPlanta.Codigo, al_guia, li_tipoembq, False, SQLCA) 
		
		ii_tipoemb = li_tipoembq
				
	If sqlca.SQLCode = -1 Then
		F_ErrorBaseDatos(sqlca,"Lectura de la Tabla DESPAFRIGOEN")
		em_nroguia.SetFocus()
		Return False
	ElseIf sqlca.SQLCode = 100 Then
		MessageBox("Atención", "No existe Número Guia Despacho Indicado.~r~r" +&
				"Ingrese otro Número.", Exclamation!, Ok!)
		pb_imprime.Enabled	= False
		pb_acepta.Enabled	= False
		em_nroguia.Text = ''
		em_nroguia.SetFocus()
		Return False
	ElseIf li_tipoembq = 7 OR li_tipoembq = 8 OR li_tipoembq = 9 Then		
		SELECT embq_codigo, defe_tecnic, defe_plasag, defe_nturno, defe_fecdes
		INTO	:ls_Embarque, :li_tecnic, :al_planilla, :is_tipopla, :ld_fecha	
		FROM	dbo.DESPAFRIGOEN 
		WHERE	plde_codigo =	:uo_SelPlanta.Codigo
		AND	clie_codigo	=	:uo_SelCliente.Codigo
		AND	defe_guides	=	:al_guia;
		
		is_embarque = ls_Embarque
		
		iuo_Embarques.Existe(is_embarque, uo_SelCliente.Codigo, False, Sqlca)
		iuo_Embarcador.Existe(iuo_Embarques.Embarcador, False, Sqlca)
		
		If ls_Embarque <> '' Then
			If ExisteOperacion(ls_Embarque) Then
			End If	
		End If	
								
		SELECT RTrim(tecn_nombre)+' '+RTrim(tecn_apepat)+' '+RTrim(tecn_apemat)
		INTO  :ls_contraparte
		FROM dbo.cargostecnicos
		WHERE tecn_codigo = :li_tecnic
		AND plde_codigo = :uo_SelPlanta.Codigo;

		SELECT embq_tipova, embc_codigo, pu.puer_nombre, de.dest_nombre
		INTO	:li_Tipova, :li_embc_codigo, :ls_puerto, :ls_destino
		FROM	dbo.EMBARQUEPROD as em, dbo.destinos as de, dbo.puertos as pu
		WHERE	em.clie_codigo	=	:uo_SelCliente.Codigo
		AND	em.embq_codigo	=	:ls_Embarque
		AND	em.puer_codigo =	pu.puer_codigo
		AND	em.dest_codigo = 	de.dest_codigo;
		
		SELECT  isnull(defe_cansel,0), isnull(defe_numsel,''), isnull(defe_ubisel,'')
		INTO	:li_cansel,  :ls_numsel,  :ls_ubisel
		FROM	dbo.DESPAFRIGOEN 
		WHERE	plde_codigo =	:uo_SelPlanta.Codigo
		AND	clie_codigo	=	:uo_SelCliente.Codigo
		AND	defe_plasag	=	:al_planilla
		AND   defe_nturno =  :is_tipopla
		AND   defe_fecdes =  :ld_fecha
		AND   defe_numero =  :il_despacho;	
		
		ll_fila = dw_3.Retrieve(uo_SelPlanta.Codigo,al_planilla)
		
		If ll_fila > 0 Then
			FOR ll_fila1 = 1 TO dw_3.RowCount()
				ls_numsel = ls_numsel+''+dw_3.Object.sell_numero[ll_fila1]+'-'
				ls_ubisel = ls_ubisel+''+dw_3.Object.sell_nombre[ll_fila1]+'-'
			NEXT
		End If	
		
		em_cansellos.Text = String(ll_fila)
		
		ls_numsel = Mid(ls_numsel, 1,len(ls_numsel) -1 )
		ls_ubisel = Mid(ls_ubisel, 1,len(ls_ubisel) -1 )
		
		em_numsellos.Text		=	ls_numsel
		em_ubisellos.Text			=	ls_ubisel
								
		If sqlca.SQLCode = -1 Then
			MessageBox("Atención", "Problema en Selección de Detalle en Encabezado del Despacho.", Exclamation!, Ok!)	
		End If
			
		If sqlca.SQLCode = -1 Then
			F_ErrorBaseDatos(sqlca,"Lectura de la Tabla EMBARQUEPROD")
			em_nroguia.Text = ''
			em_nroguia.SetFocus()
			Return False
		Else					
			SELECT embc_nombre, embc_direcc, embc_nrorut, embc_ciudad
			INTO	:is_Recibidor, :is_Direccion, :is_Rut, :is_ciudad
			FROM	dbo.EMBARCADORES 
			WHERE	embc_codigo	=	:li_embc_codigo;	
			
			If sqlca.SQLCode = -1 Then
				F_ErrorBaseDatos(sqlca,"Lectura de la Tabla EMBARCADORES")
				em_nroguia.Text = ''
				em_nroguia.SetFocus()
				Return False
			ElseIf sqlca.SQLCode = 100 Then
				
					MessageBox("Atención", "No existe Embarcadores.~r~r", &
								Exclamation!, Ok!)
					pb_imprime.Enabled	= False
					em_nroguia.Text = ''
					em_nroguia.SetFocus()
					Return False			
			Else
				SELECT count(*)
				INTO	:ll_contpal
				FROM	dbo.despafrigode as det,dbo.DESPAFRIGOEN as enc
				WHERE	enc.plde_codigo =	:uo_SelPlanta.Codigo
				AND	enc.clie_codigo =	:uo_SelCliente.Codigo
				AND	enc.defe_guides =	:al_guia
				AND	enc.clie_codigo = det.clie_codigo
				AND	enc.plde_codigo = det.plde_codigo
				AND	enc.defe_numero = det.defe_numero;	
				
				If sqlca.SQLCode = -1 Then
					F_ErrorBaseDatos(sqlca,"Lectura de la Tabla Despachos")
					em_nroguia.Text = ''
					em_nroguia.SetFocus()
					Return False
				End If
				
				If ll_contpal >= 4 Then
					SELECT count(*)
					INTO	:ll_cont
					FROM	dbo.despafrigode as det,dbo.DESPAFRIGOEN as enc
					WHERE	enc.plde_codigo =	:uo_SelPlanta.Codigo
					AND	enc.clie_codigo =	:uo_SelCliente.Codigo
					AND	enc.defe_guides =	:al_guia
					AND	enc.clie_codigo = det.clie_codigo
					AND	enc.plde_codigo = det.plde_codigo
					AND	enc.defe_numero = det.defe_numero
					AND 	isnull(det.defe_tempe1,0) <> 0;	
							
					If sqlca.SQLCode = -1 Then
						F_ErrorBaseDatos(sqlca,"Lectura de la Tabla Despachos")
						em_nroguia.Text = ''
						em_nroguia.SetFocus()
						Return False
					ElseIf ll_cont < 2 Then
						MessageBox("Atención", "Debe Registrar la Temperatura de al Menos 2 Pallet de esta Guía.~r~r", &
									Exclamation!, Ok!)
						pb_imprime.Enabled	= False
						pb_acepta.Enabled	= False
						em_nroguia.Text = ''
						em_nroguia.SetFocus()
						Return False	
					End If	
				End If
				
   			If li_consol=1 Then
				  SELECT  plde_nombre,plde_nrorut,plde_direcc,plde_ciudad
					INTO :is_Recibidor,:is_Rut,:is_Direccion,:is_ciudad
					FROM dbo.plantadesp
					WHERE plde_codigo=:li_plades;					
            End If
				
				istr_mant.argumento[25]	=	String(li_Tipova)
				em_recibidor.Text			=	is_Recibidor
				em_rut.Text					=	is_Rut
				em_direccion.Text			=	is_Direccion
				em_nomdespachador.Text	=  ls_contraparte
				em_ciudad.Text				=	is_ciudad
				pb_imprime.Enabled			= 	True
				If  ii_tipo = 1 OR ii_tipo = 3 Then
					em_recibidor.Enabled	=	True
					em_rut.Enabled			=	True
					em_direccion.Enabled	=	True
					em_puerto.Text 		=	ls_puerto
					em_destino.Text		=	ls_destino
				End If
				Return True
			End If
		End If
				
	ElseIf li_tipoembq = 21 OR li_tipoembq = 16 OR li_tipoembq = 31 Then
		SELECT embq_codigo,clpr_rut, defe_plasag, defe_nturno, defe_fecdes
		INTO	:ls_embarque,:is_rut,:al_planilla, :is_tipopla, :ld_fecha	
		FROM	dbo.DESPAFRIGOEN 
		WHERE	plde_codigo =	:uo_SelPlanta.Codigo
		AND	clie_codigo	=	:uo_SelCliente.Codigo
		AND	defe_guides	=	:al_guia;
		
		is_embarque  = ls_embarque
		
		SELECT clpr_nombre,clpr_direcc
		INTO  :is_Recibidor,:is_Direccion
		FROM dbo.clienprove
		WHERE clpr_rut = :is_rut;
		
		SELECT embq_tipova, embc_codigo, pu.puer_nombre, de.dest_nombre
		INTO	:li_Tipova, :li_embc_codigo, :ls_puerto, :ls_destino
		FROM	dbo.EMBARQUEPROD as em, dbo.destinos as de, dbo.puertos as pu
		WHERE	em.clie_codigo	=	:uo_SelCliente.Codigo
		AND	em.embq_codigo	=	:ls_Embarque
		AND	em.puer_codigo =	pu.puer_codigo
		AND	em.dest_codigo = 	de.dest_codigo;
		
		SELECT  isnull(defe_cansel,0), isnull(defe_numsel,''), isnull(defe_ubisel,'')
		INTO	:li_cansel,  :ls_numsel,  :ls_ubisel
		FROM	dbo.DESPAFRIGOEN 
		WHERE	plde_codigo =	:uo_SelPlanta.Codigo
		AND	clie_codigo	=	:uo_SelCliente.Codigo
		AND	defe_plasag	=	:al_planilla
		AND   defe_nturno =  :is_tipopla
		AND   defe_fecdes =  :ld_fecha
		AND   defe_numero =  :il_despacho;	
		
		ll_fila = dw_3.Retrieve(uo_SelPlanta.Codigo,al_planilla)
		
		If ll_fila > 0 Then
			FOR ll_fila1 = 1 TO dw_3.RowCount()
				ls_numsel = ls_numsel+''+dw_3.Object.sell_numero[ll_fila1]+'-'
				ls_ubisel = ls_ubisel+''+dw_3.Object.sell_nombre[ll_fila1]+'-'
			NEXT
		End If
		
		SELECT count(*)
		INTO	:ll_contpal
		FROM	dbo.despafrigode as det,dbo.DESPAFRIGOEN as enc
		WHERE	enc.plde_codigo =	:uo_SelPlanta.Codigo
		AND	enc.clie_codigo =	:uo_SelCliente.Codigo
		AND	enc.defe_guides =	:al_guia
		AND	enc.clie_codigo = det.clie_codigo
		AND	enc.plde_codigo = det.plde_codigo
		AND	enc.defe_numero = det.defe_numero;	
		
		If sqlca.SQLCode = -1 Then
			F_ErrorBaseDatos(sqlca,"Lectura de la Tabla Despachos")
			em_nroguia.Text = ''
			em_nroguia.SetFocus()
			Return False
		End If
		
		If ll_contpal >= 4 Then
			SELECT count(*)
			INTO	:ll_cont
			FROM	dbo.despafrigode as det,dbo.DESPAFRIGOEN as enc
			WHERE	enc.plde_codigo =	:uo_SelPlanta.Codigo
			AND	enc.clie_codigo =	:uo_SelCliente.Codigo
			AND	enc.defe_guides =	:al_guia
			AND	enc.clie_codigo = det.clie_codigo
			AND	enc.plde_codigo = det.plde_codigo
			AND	enc.defe_numero = det.defe_numero
			AND 	isnull(det.defe_tempe1,0) <> 0;	
					
			If sqlca.SQLCode = -1 Then
				F_ErrorBaseDatos(sqlca,"Lectura de la Tabla Despachos")
				em_nroguia.Text = ''
				em_nroguia.SetFocus()
				Return False
			ElseIf ll_cont < 2 Then
				MessageBox("Atención", "Debe Registrar la Temperatura de al Menos 2 Pallet de esta Guía.", &
							Exclamation!, Ok!)
				pb_imprime.Enabled	= False
				pb_acepta.Enabled	= False
				em_nroguia.Text = ''
				em_nroguia.SetFocus()
				Return False	
			End If	
		End If
		em_cansellos.Text = String(ll_fila)
		
		ls_numsel = Mid(ls_numsel, 1,len(ls_numsel) -1 )
		ls_ubisel = Mid(ls_ubisel, 1,len(ls_ubisel) -1 )
		
		em_numsellos.Text			=	ls_numsel
		em_ubisellos.Text			=	ls_ubisel
		
		istr_mant.argumento[25]	=	String(li_Tipova)
		em_recibidor.Text			=	is_Recibidor
		em_rut.Text					=	is_rut
		em_direccion.Text			=	is_Direccion
		em_puerto.Text 			=	ls_puerto
		em_destino.Text			=	ls_destino
		pb_imprime.Enabled		= 	True
		em_recibidor.Enabled		=	True
		em_rut.Enabled			=	True				
		em_direccion.Enabled		=	True

	ElseIf li_tipoembq = 11 Then
		SELECT count(*)
		INTO	:ll_contpal
		FROM	dbo.despafrigode as det,dbo.DESPAFRIGOEN as enc
		WHERE	enc.plde_codigo =	:uo_SelPlanta.Codigo
		AND	enc.clie_codigo =	:uo_SelCliente.Codigo
		AND	enc.defe_guides =	:al_guia
		AND	enc.clie_codigo = det.clie_codigo
		AND	enc.plde_codigo = det.plde_codigo
		AND	enc.defe_numero = det.defe_numero;	
						
		If sqlca.SQLCode = -1 Then
			F_ErrorBaseDatos(sqlca,"Lectura de la Tabla Despachos")
			em_nroguia.Text = ''
			em_nroguia.SetFocus()
			Return False
		ElseIf  ll_contpal >= 4 Then
			SELECT count(*)
			INTO	:ll_cont
			FROM	dbo.despafrigode as det,dbo.DESPAFRIGOEN as enc
			WHERE	enc.plde_codigo =	:uo_SelPlanta.Codigo
			AND	enc.clie_codigo =	:uo_SelCliente.Codigo
			AND	enc.defe_guides =	:al_guia
			AND	enc.clie_codigo = det.clie_codigo
			AND	enc.plde_codigo = det.plde_codigo
			AND	enc.defe_numero = det.defe_numero
			AND 	isnull(det.defe_tempe1,0) <> 0;	
			
			If ll_cont < 2 Then
				MessageBox("Atención", "Debe Registrar la Temperatura de al Menos 2 Pallet de esta Guía.", Exclamation!, Ok!)
				pb_imprime.Enabled	= False
				em_nroguia.Text = ''
				em_nroguia.SetFocus()
				Return False	
			End If	
		End If
		
		em_recibidor.Enabled		=	True
		em_rut.Enabled				=	True				
		em_direccion.Enabled		=	True
		istr_mant.argumento[25]	=	'1'
		pb_imprime.Enabled	= True
		Return True	
	Else	
		SELECT count(*)
		INTO	:ll_contpal
		FROM	dbo.despafrigode as det,dbo.DESPAFRIGOEN as enc
		WHERE	enc.plde_codigo =	:uo_SelPlanta.Codigo
		AND	enc.clie_codigo =	:uo_SelCliente.Codigo
		AND	enc.defe_guides =	:al_guia
		AND	enc.clie_codigo = det.clie_codigo
		AND	enc.plde_codigo = det.plde_codigo
		AND	enc.defe_numero = det.defe_numero;	
		
		If sqlca.SQLCode = -1 Then
			F_ErrorBaseDatos(sqlca,"Lectura de la Tabla Despachos")
			em_nroguia.Text = ''
			em_nroguia.SetFocus()
			Return False
		End If
		
		If ll_contpal >= 4 Then
			SELECT count(*)
			INTO	:ll_cont
			FROM	dbo.despafrigode as det,dbo.DESPAFRIGOEN as enc
			WHERE	enc.plde_codigo =	:uo_SelPlanta.Codigo
			AND	enc.clie_codigo =	:uo_SelCliente.Codigo
			AND	enc.defe_guides =	:al_guia
			AND	enc.clie_codigo = det.clie_codigo
			AND	enc.plde_codigo = det.plde_codigo
			AND	enc.defe_numero = det.defe_numero
			AND 	isnull(det.defe_tempe1,0) <> 0;	
					
			If sqlca.SQLCode = -1 Then
				F_ErrorBaseDatos(sqlca,"Lectura de la Tabla Despachos")
				em_nroguia.Text = ''
				em_nroguia.SetFocus()
				Return False
			ElseIf ll_cont < 2 Then
				MessageBox("Atención", "Debe Registrar la Temperatura de al Menos 2 Pallet de esta Guía.", Exclamation!, Ok!)
				pb_imprime.Enabled	= False
				em_nroguia.Text = ''
				em_nroguia.SetFocus()
				Return False	
			End If	
		End If
		istr_mant.argumento[25]	=	'1'
		pb_imprime.Enabled	= True
		Return True
	End If
Else
	MessageBox("Atención", "Faltan parámetros de búsqueda.~r~rIngreselos todos.", Exclamation!, Ok!)
	Return False
End If
end function

public subroutine enviamail ();Long			ll_Archivo
str_parms	lstr_parms

SetPointer(HourGlass!)

lstr_parms.string_arg[1]			=	String(1)
lstr_parms.string_arg[2]			=	'Guia Despacho Nº '+is_asunto
lstr_parms.string_arg[3]			=	String(1)

ll_Archivo = 1
lstr_parms.string_arg[ll_Archivo+3]		=	is_archivo
OpenWithParm(w_correo_archivo_saam, lstr_parms)
	
If FileExists(lstr_parms.string_arg[ll_Archivo + 3]) Then FileDelete(lstr_parms.string_arg[ll_Archivo + 3])

SetPointer(Arrow!)
end subroutine

public function boolean valida_datos ();Long ll_fila, ll_cont, ll_pallet
String	ls_mensaje
Integer	li_cliente, li_planta

li_cliente =	uo_SelCliente.Codigo
li_planta	=	uo_SelPlanta.Codigo

ls_mensaje = ''

FOR ll_fila = 1 TO dw_5.RowCount()
	
	ll_pallet = dw_5.Object.paen_numero[ll_fila]
	
	SELECT Count(*)
	INTO :ll_cont
	FROM dbo.palletfruta
	WHERE paen_numero = :ll_pallet
	AND clie_codigo = :li_cliente
	AND plde_codigo = :li_planta
	AND (isnull(PAFR_CUART1,0) = 0
	OR isnull(PAFR_CUART4,0) = 0
	OR isnull(PAFR_HUERT1,0) = 0
	OR isnull(PAFR_HUERT4,0) = 0);
	
	IF ll_cont > 0 THEN
		ls_mensaje = ls_mensaje + String(ll_Pallet)+','
	END IF	
	
//	SELECT Count()
//	INTO :ll_cont
//	FROM dbo.palletfruta
//	WHERE paen_numero = :ll_pallet
//	AND (isnull(PAFR_CUART4,0) = 0;
//	
//	IF ll_cont > 0 THEN
//		ls_mensaje = ls_mensaje + String(ll_Pallet)+','
//	END IF	
//	
//	SELECT Count()
//	INTO :ll_cont
//	FROM dbo.palletfruta
//	WHERE paen_numero = :ll_pallet
//	AND isnull(PAFR_HUERT1,0) = 0;
//	
//	IF ll_cont > 0 THEN
//		ls_mensaje = ls_mensaje + String(ll_Pallet)+','
//	END IF	
//	
//	SELECT Count()
//	INTO :ll_cont
//	FROM dbo.palletfruta
//	WHERE paen_numero = :ll_pallet
//	AND isnull(PAFR_HUERT4,0) = 0;
//	
//	IF ll_cont > 0 THEN
//		ls_mensaje = ls_mensaje + String(ll_Pallet)+','
//	END IF	
NEXT	

IF ls_mensaje <> '' THEN
	MessageBox("Atención", "Pallet "+String(ls_mensaje)+" con Predio o Cuartel Nulo.~r~rArregle por Movimientos -> Mantención -> Mantención Predio Cuartel Detalle Pallet.", &
						Exclamation!, Ok!)
	Return True
END IF



Return False

	
end function

public function boolean obtiene_condicion (integer ai_cliente, integer ai_planta, long al_pallet);Long li_Existe
Date ld_fecha

	ii_condicion = 0
	
  SELECT max(fumi_fecfum)  
    INTO :ld_fecha
    FROM dbo.fumigadet as det,dbo.fumigaenc as enc 
   WHERE det.clie_codigo = :ai_cliente AND  
         det.plde_codigo = :ai_planta  AND  
         det.paen_numero = :al_pallet AND
			det.clie_codigo = enc.clie_codigo AND
			det.plde_codigo = enc.plde_codigo AND
			det.cond_codigo = enc.cond_codigo AND
			det.fumi_numero = enc.fumi_numero
	GROUP BY det.cond_codigo;
	
	
	SELECT det.cond_codigo  
    INTO :ii_condicion 
    FROM dbo.fumigadet as det,dbo.fumigaenc as enc 
   WHERE det.clie_codigo = :ai_cliente AND  
         det.plde_codigo = :ai_planta  AND  
         det.paen_numero = :al_pallet AND
			det.clie_codigo = enc.clie_codigo AND
			det.plde_codigo = enc.plde_codigo AND
			det.cond_codigo = enc.cond_codigo AND
			det.fumi_numero = enc.fumi_numero AND
			enc.fumi_fecfum = :ld_fecha;
	

	IF sqlca.SQLCode = -1 THEN
		F_ErrorBaseDatos(sqlca,"Lectura de la Tabla fumigadet")
		//em_despacho.SetFocus()
		RETURN True
	ELSEIF sqlca.SQLCode = 100 THEN
//		MessageBox("Atención", "No existe Guía Despacho Indicada.~r~rIngrese otro Número.", &
//						Exclamation!, Ok!)
//		pb_grabar.Enabled	= False
//		em_despacho.SetFocus()
		RETURN True
	ELSE
//		pb_grabar.Enabled	= True
		RETURN False
	END IF
	
Return False
end function

public function boolean existearchivo (integer li_cliente, integer li_planta, long ll_guia, long al_planillas, string as_tipoplanilla, string as_instructivo);Date ld_fecha
Time lt_hora
Integer li_contador, li_code_gengde
Long ll_numero
String	ls_embarque

//ls_embarque = String(em_operacion.Text)

SELECT defe_numero
INTO	:ll_numero
FROM	dbo.DESPAFRIGOEN 
WHERE	plde_codigo =	:li_planta
AND	clie_codigo	=	:li_cliente
AND	defe_guides	=	:ll_guia
AND   defe_plasag =  :al_planilla
AND   embq_codigo =  :as_instructivo;

If sqlca.SQLCode = -1 Then
	F_ErrorBaseDatos(sqlca,"Lectura de la Tabla DESPAFRIGOEN")
	Return True
ElseIf sqlca.SQLCode = 100 Then
	MessageBox("Atención", "No existe Número Guia Indicado.~r~rIngrese otro Número.", &
					Exclamation!, Ok!)
	Return True
End If

SELECT count(*),max(CODE_FECHAA),max(CODE_HORAAP)
INTO :li_contador,:ld_fecha,:lt_hora
FROM dbo.CONTROLDESPACHOS
where plde_codigo =	:li_planta
AND	clie_codigo	=	:li_cliente
AND	defe_numero	=	:ll_numero;

If sqlca.SQLCode = -1 Then
	F_ErrorBaseDatos(sqlca,"Lectura de la Tabla CONTROLDESPACHOS")
	Return True
End If

If li_contador > 0 Then
	Select CODE_GEMSAA 
	INTO :li_code_gengde
	from dbo.CONTROLDESPACHOS
	where  plde_codigo =	:li_planta
		AND	clie_codigo =	:li_cliente
		AND	defe_numero =	:ll_numero
		AND	CODE_FECHAA =  :ld_fecha
		AND	CODE_HORAAP = 	:lt_hora;
		
	If li_code_gengde = 1 Then
		MessageBox("Atención", "El Archivo S.A.A.M ya Fue Generado.", Exclamation!, Ok!)
		Return True
	End If		
End If

Return FALSE
end function

public function boolean existeoperacion (string operacion);Integer	li_puerto
String		ls_nave, ls_embarque
Date		ld_fzarpe

ls_embarque	=	operacion

IF ls_embarque <> "" THEN
	
	SELECT	embq_nomnav, embq_fzarpe, embq_ptoori
		INTO	:ls_nave, :ld_fzarpe, :li_puerto
		FROM	dbo.EMBARQUEPROD
		WHERE	clie_codigo	=	:uo_SelCliente.Codigo
		AND	embq_codigo =	:ls_embarque ;
				
	IF sqlca.SQLCode = -1 THEN
		F_ErrorBaseDatos(sqlca,"Lectura de la Tabla EMBARQUEPROD")
		RETURN False
	ELSEIF sqlca.SQLCode = 100 THEN
		MessageBox("Atención", "No existe Instructivo Indicada.~r~rIngrese otro Número.", &
						Exclamation!, Ok!)

		RETURN False
	ELSE
		
		SELECT puer_correo
		INTO :is_correosaampuerto
		FROM dbo.puertos 
		WHERE puer_codigo = :li_puerto;

		RETURN True
	END IF
ELSE
	MessageBox("Atención", "Faltan parámetros de búsqueda.~r~rIngreselos todos.", &
					Exclamation!, Ok!)
	RETURN False
END IF
end function

public function boolean wf_actualiza_db (boolean borrando);Boolean	lb_AutoCommit, lb_Retorno

//IF Not dw_2.uf_check_required(0) THEN RETURN False

//IF Not dw_1.uf_validate(0) THEN RETURN False

lb_AutoCommit		=	sqlca.AutoCommit
sqlca.AutoCommit	=	False

IF Borrando THEN
//	IF dw_1.Update(True, False) = 1 THEN
//		IF dw_2.Update(True, False) = 1 THEN
//			Commit;
//			
//			IF sqlca.SQLCode <> 0 THEN
//				F_ErrorBaseDatos(sqlca, This.Title)
//				
//				RollBack;
//			ELSE
//				lb_Retorno	=	True
//				
//				dw_1.ResetUpdate()
//				dw_2.ResetUpdate()
//			END IF
//		ELSE
//			F_ErrorBaseDatos(sqlca, This.Title)
//			
//			RollBack;
//		END IF
//	ELSE
//		F_ErrorBaseDatos(sqlca, This.Title)
//	END IF
ELSE
//	IF dw_2.Update(True, False) = 1 THEN
		IF dw_4.Update(True, False) = 1 THEN
			Commit;
			
			IF sqlca.SQLCode <> 0 THEN
				F_ErrorBaseDatos(sqlca, This.Title)
				
				RollBack;
			ELSE
				lb_Retorno	=	True
				
				//dw_1.ResetUpdate()
				//dw_2.ResetUpdate()
				dw_4.ResetUpdate()
			END IF
		ELSE
			F_ErrorBaseDatos(sqlca, This.Title)
			
			RollBack;
		END IF
//	ELSE
//		F_ErrorBaseDatos(sqlca, This.Title)
//	END IF
END IF

sqlca.AutoCommit	=	lb_AutoCommit

RETURN lb_Retorno
end function

protected function integer despacho (integer li_cliente, integer li_planta, long ll_guia);Long 		ll_numero
Integer	li_contador
Datetime	ldt_hora, ld_fecha
Time		ld_hora

ldt_hora			=	Datetime(Date(Today()),Time(Today())	)

SELECT defe_numero
INTO	:ll_numero
FROM	dbo.DESPAFRIGOEN 
WHERE	plde_codigo =	:li_planta
AND	clie_codigo	=	:li_cliente
AND	defe_guides	=	:ll_guia;

If sqlca.SQLCode = -1 THEN
	F_ErrorBaseDatos(sqlca,"Lectura de la Tabla DESPAFRIGOEN")
	RETURN 0
ELSEIf sqlca.SQLCode = 100 THEN
	MessageBox("Atención", "No existe Número Guia Despacho Indicado.~r~rIngrese otro Número.", Exclamation!, Ok!)
	RETURN 0
END If

If Not wf_trazabilidad(li_Cliente, li_Planta, ll_Numero) Then RETURN 0

ii_controlsaam = 0

SELECT max(CODE_FECHAA)
INTO :ld_fecha
FROM dbo.CONTROLDESPACHOS
where plde_codigo =	:li_planta
AND	clie_codigo	=	:li_cliente
AND	defe_numero	=	:ll_numero;

SELECT max(CODE_HORAAP)
INTO :ld_hora
FROM dbo.CONTROLDESPACHOS
where plde_codigo =	:li_planta
AND	clie_codigo	=	:li_cliente
AND	defe_numero	=	:ll_numero
AND   CODE_FECHAA =  :ld_fecha;

SELECT isnull(CODE_GENGDE,0)
INTO :ii_controlsaam
FROM dbo.CONTROLDESPACHOS
where plde_codigo =	:li_planta
AND	clie_codigo	=	:li_cliente
AND	defe_numero	=	:ll_numero
AND   CODE_FECHAA =  :ld_fecha
AND	DateDiff(ss, CODE_HORAAP, :ld_hora) = 0;

SELECT count(*)
INTO :li_contador
FROM dbo.CONTROLDESPACHOS
where plde_codigo =	:li_planta
AND	clie_codigo	=	:li_cliente
AND	defe_numero	=	:ll_numero
AND   CODE_FECHAA =  :ld_fecha
And 	DateDiff(ss, CODE_HORAAP, :ld_hora) = 0;

IF sqlca.SQLCode = -1 THEN
	F_ErrorBaseDatos(sqlca,"Lectura de la Tabla CONTROLDESPACHOS")
	RETURN 0
END IF

IF li_contador > 0 THEN
	IF ii_tipo = 1 THEN
		UPDATE dbo.CONTROLDESPACHOS 
			Set  	CODE_GENGDE = 1,
					CODE_FECGDE = :ldt_hora,
					CODE_GEMIDE = 1
			WHERE  plde_codigo =	:li_planta
			AND	 clie_codigo =	:li_cliente
			AND	 defe_numero =	:ll_numero
			AND    CODE_FECHAA = :ld_fecha
			And  DateDiff(ss, CODE_HORAAP, :ld_hora) = 0;
			  
		Commit;
		
		IF sqlca.SQLCode = -1 THEN
			F_ErrorBaseDatos(sqlca,"Lectura de la Tabla CONTROLDESPACHOS")
			RETURN 0
		END IF
	ELSE	
		UPDATE dbo.CONTROLDESPACHOS 
		SET CODE_DEMADE = 1
   		WHERE  plde_codigo =	:li_planta
		AND	 clie_codigo =	:li_cliente
		AND	 defe_numero =	:ll_numero
		AND    CODE_FECHAA = :ld_fecha
		
		AND	 DateDiff(ss, CODE_HORAAP, :ld_hora) = 0;
		Commit;
	END IF	
END IF	

Return 0
end function

public function boolean validadespacho (integer li_cliente, integer li_planta, long ll_guia);Long ll_numero
Integer li_contador, li_count, li_code_gengde, li_code_gemide, li_code_demade
Date ld_fecha
Time lt_hora
String	ls_embarque

SELECT max(defe_numero)
INTO	:ll_numero
FROM	dbo.DESPAFRIGOEN 
WHERE	plde_codigo =	:li_planta
AND	clie_codigo	=	:li_cliente
AND	defe_guides	=	:ll_guia;

If sqlca.SQLCode = -1 Then
	F_ErrorBaseDatos(sqlca,"Lectura de la Tabla DESPAFRIGOEN")
	Return True
ElseIf sqlca.SQLCode = 100 Then
	MessageBox("Atención", "No existe Número Guia Indicado.~r~rIngrese otro Número.", Exclamation!, Ok!)
	Return True
End If

SELECT count(*),max(CODE_FECHAA),max(CODE_HORAAP)
INTO :li_contador,:ld_fecha,:lt_hora
FROM dbo.CONTROLDESPACHOS
where plde_codigo =	:li_planta
AND	clie_codigo	=	:li_cliente
AND	defe_numero	=	:ll_numero;

If sqlca.SQLCode = -1 Then
	F_ErrorBaseDatos(sqlca,"Lectura de la Tabla CONTROLDESPACHOS")
	Return True
End If

If li_contador > 0 Then
	Select CODE_DEMADE 
	INTO :li_code_demade
	from dbo.CONTROLDESPACHOS
	where  plde_codigo =	:li_planta
		AND	clie_codigo =	:li_cliente
		AND	defe_numero =	:ll_numero
		AND	CODE_FECHAA =  :ld_fecha;
	
	If Isnull(li_code_demade) OR li_code_demade = 0 Then
		MessageBox("Atención", "Falta Generar Listado Anexo de Despacho.", Exclamation!, Ok!)
		Return True
	End If		
End If	

Return False			
			

end function

public subroutine enviaguiasaam ();String			ls_Archivo, ls_asunto, ls_texto, ls_tipodespa
Long			ll_Fila, ll_Archivo, ll_Result, ll_nroguia

str_parms	lstr_parms

ll_nroguia	= Long(em_nroguia.Text)

If uo_SelCliente.Codigo <> 81 Then Return

SetPointer(HourGlass!)

lstr_parms.string_arg[1]	=	String(1)
lstr_parms.string_arg[2]	=	is_archivo
lstr_parms.string_arg[3]	=	String(1)

ll_Archivo = 1

lstr_parms.string_arg[ll_Archivo+3]	=	is_ArchivoGuias+'.PDF'
ls_Archivo	=	is_ArchivoGuias+'.PDF'
ls_tipodespa	=	Mid(is_archivo,9,1)

iuo_Embarques.Existe(is_Embarque, uo_SelCliente.Codigo, True, Sqlca)
iuo_Embarcador.Existe(iuo_Embarques.Embarcador, True, SqlCa)
iuo_Planta.Existe(uo_SelPlanta.Codigo, True, Sqlca)

ls_Asunto = iuo_Embarques.NombreNave + SEPARADOR + iuo_Embarques.NombrePuerto + SEPARADOR + &
		String(iuo_Embarques.Operacion, '00') + '-' + iuo_Embarques.Codigo + SEPARADOR + String(iuo_Planta.Codigo, '0000') + SEPARADOR + &
		em_nroguia.Text 

ls_texto	=	 'Guía Despacho '+String(ll_nroguia)+' con fecha ' + String(Today(),'dd/mm/yyyy')+' Planta ' +String(iuo_Planta.Codigo)+'.' 

If Upper(ls_tipodespa) = 'P' OR Upper(ls_tipodespa) = 'N' Then
	iuo_Mail.Of_Send(iuo_Planta.Mail,ls_asunto,ls_texto,{ls_Archivo}, 0) 
Else
	iuo_Mail.Of_Send(iuo_Embarcador.Mail,iuo_Planta.Mail, ls_asunto,ls_texto, {ls_Archivo}, 0)
End If	

//If ll_Result < 0 Then
//	messagebox("Error en el envio de mail - Error No" + string(ll_Result),ls_ErrorMsg+ "~r~nIntente enviar correo en forma manual")
//	OpenWithParm(w_correo_archivo_saam, lstr_parms)
//	ii_controlcorreo = 1
//Else
//	Messagebox("Aviso", "Envio de correo exitoso")
//	ii_controlcorreo = 0
//End If

SetPointer(Arrow!)
end subroutine

protected function boolean wf_trazabilidad (integer cliente, integer planta, long numero);Boolean lb_Retorno = True

DECLARE Trazabilidad_Despacho PROCEDURE FOR dbo.Traz_ActulizaTerminoDespacho	
			@Cliente	= :Cliente,
			@Planta = :Planta,
			@Numero = :Numero;

EXECUTE Trazabilidad_Despacho;

If Sqlca.SQLCode = -1 Then
	F_ErrorBaseDatos(sqlca,"Lectura de la Tabla DESPAFRIGOEN")
	lb_Retorno  = False
End If

Commit;

Return lb_Retorno



end function

public subroutine wf_generaguia_ws ();uo_ws_embarcador	luo_Rossi
luo_Rossi	=	Create uo_ws_embarcador

luo_Rossi.of_SetURL(iuo_Embarcador.URL)
luo_Rossi.of_SetHeaders(iuo_Embarcador.Header)

luo_Rossi.of_SetAsunto(iuo_Embarques.NombreNave + SEPARADOR + iuo_Embarques.NombrePuerto + SEPARADOR + &
		String(iuo_Embarques.Operacion, '00') + '-' + iuo_Embarques.Codigo + SEPARADOR + String(uo_SelPlanta.Codigo, '0000') + SEPARADOR + &
		em_nroguia.Text + ' - Carga JSON Automático.')
		
luo_Rossi.of_SetCuerpo('')
luo_Rossi.of_SetCorreo(uo_SelPlanta.Mail)
	
luo_Rossi.of_CargaGuia(uo_SelCliente.Codigo, uo_SelPlanta.Codigo, al_planilla, is_embarque, dw_error)

If dw_error.RowCount() > 0 Then dw_error.Visible = True

Destroy luo_Rossi
end subroutine

public subroutine wf_generaarchivo ();Long			ll_fila, ll_filas, ll_filadet, ll_guia, ll_numero, ll_cont, ll_planilla, ll_filcont
String			ls_Cliente, ls_Planta, ls_Patente, ls_Archivo, ls_Registro, ls_embarque,&
				ls_termog, ls_guia, ls_Instructivo
double		ll_termog
Integer		li_copallet, li_cliente,  li_Tipova, li_Planta
Datetime    	ldt_hora

ldt_hora			=	Datetime(Date(Today()),Time(Today())	)

dw_6.reset()
dw_7.reset()
dw_4.reset()
dw_5.reset()

dw_7.SetTransObject(Sqlca)
dw_6.SetTransObject(Sqlca)

// Para actualizar el estado=1 Cerrado, una vez generado el archivo
dw_4.SetTransObject(SQLCA)
dw_5.SetTransObject(SQLCA)
dw_guia.SetTransObject(SQLCA)

ls_Cliente		=	String(uo_SelCliente.Codigo, '000')
ls_Planta			=	String(uo_SelPlanta.Codigo, '0000')
ls_guia 			=  em_nroguia.Text
ll_guia 			=  Long(em_nroguia.Text)
ls_Instructivo	=	is_embarque
ls_embarque	=	is_embarque
ll_planilla			=	al_planilla

ls_Archivo	=  "RIOB" +ls_Instructivo+"-"+ string(ll_planilla) + "." + Mid(ls_Planta, 2, 3) + ls_guia
is_archivo	=	ls_Archivo

ll_filcont		=  dw_5.Retrieve(uo_SelCliente.Codigo,uo_SelPlanta.Codigo,ll_planilla,ii_var,ii_cal,ii_prod,ll_guia, 0, '-1',ls_Instructivo)
If ll_filcont > 0 Then
	If valida_datos() Then
		Return
	End If	
End If	

ll_filas			=  dw_6.Retrieve(uo_SelCliente.Codigo,uo_SelPlanta.Codigo,ll_planilla,ii_var,ii_cal,ii_prod,ll_guia, 0, '-1',ls_Instructivo)
									  
li_cliente = uo_SelCliente.Codigo

If ll_filas = -1 Then
	F_ErrorBaseDatos(sqlca,"Lectura de la Tabla EMBARQUEPROD")
ElseIf ll_filas = 0 Then
	MessageBox("Atención", "No hay información con Operación Indicada.~r~rIngrese otra Operación.", Exclamation!, Ok!)
Else
	dw_6.SetSort('paen_numero')
     dw_6.Sort()

	FOR ll_fila = 1 TO ll_filas
		ls_Patente	=	String(dw_6.Object.defe_patent[ll_fila])
		
		If IsNull(ls_Patente) Then ls_Patente = ''
		
		ls_Registro	=	dw_6.Object.embq_codigo[ll_fila]
		ls_Registro	+=	String(dw_6.Object.defe_guides[ll_fila], '00000000')
		ls_Registro	+=	String(dw_6.Object.reci_codigo[ll_fila], '00000')
		ls_Registro	+=	String(dw_6.Object.plde_codigo[ll_fila], '0000')
		ls_Registro	+=	ls_Patente + Fill(' ',6 - Len(ls_Patente))
		ls_Registro	+=	String(dw_6.Object.espe_codigo[ll_fila], '00')
				
		Obtiene_condicion(dw_6.Object.clie_codigo[ll_fila],dw_6.Object.plde_codigo[ll_fila],dw_6.Object.paen_numero[ll_fila])
			
		If ii_condicion = 1 Then
			ls_Registro	+=	'F'
		ElseIf dw_6.Object.paen_inspec[ll_fila] = 0 AND ii_condicion <> 1 AND ii_condicion <> 2  Then
			ls_Registro	+=	'N'
		ElseIf dw_6.Object.paen_inspec[ll_fila] = 1 Then
			ls_Registro += 'I'
		ElseIf ii_condicion = 2 Then
			ls_Registro	+=	'U'
		End If
		
		ls_Registro	+=	ls_Cliente
		ls_Registro	+=	String(dw_6.Object.paen_numero[ll_fila], '0000000')
		ls_Registro	+=	String(dw_6.Object.etiq_codigo[ll_fila], '000')
		ls_Registro	+=	String(dw_6.Object.paen_fecemb[ll_fila], 'ddmmyy')
		ls_Registro	+=	String(dw_6.Object.prod_codigo[ll_fila], '00000')
		ls_Registro	+=	String(dw_6.Object.emba_codigo[ll_fila], '@@@@@@@@@@')
		ls_Registro	+=	String(dw_6.Object.vari_codigo[ll_fila], '0000')
		ls_Registro	+=	String(dw_6.Object.pafr_calibr[ll_fila], '@@@@@')
		ls_Registro	+=	String(dw_6.Object.pafr_ccajas[ll_fila], '0000000')
		ls_Registro	+=	String(dw_6.Object.cate_codigo[ll_fila], '000')
		
		iuo_Embalaje.Existe(dw_6.Object.emba_codigo[ll_fila], False, Sqlca)
		iuo_Envase.Existe(iuo_Embalaje.TipoEnvase, iuo_Embalaje.CodEnvase, True, Sqlca)
		
		If dw_6.Object.tica_codigo[ll_fila] = 1 Then
			ls_Registro	+=	'P'
		ElseIf dw_6.Object.tica_codigo[ll_fila] = 2 Then
			ls_Registro	+=	'C'
		Else
			ls_Registro	+=	'F'
		End If
		
		If iuo_Puertos.Existe(dw_6.Object.embq_ptoori[ll_fila], False, Sqlca) Then
			ls_Registro	+=	String(iuo_Puertos.SAAM, "00")
		End If
		
		ls_Registro +=String(dw_6.Object.packing[ll_fila], '0000')

		If IsNull(dw_6.Object.defe_termog[ll_fila]) Then
			ll_termog = 0
			ls_termog = '0'
		Else
			ls_termog = String(dw_6.Object.defe_termog[ll_fila])
		End If
	   ls_Registro +=String(ls_termog, Fill("@", 15))
		
		If IsNull(dw_6.Object.copa_codigo[ll_fila]) Then
			li_copallet	= 	0
		Else
			li_copallet =	dw_6.Object.copa_codigo[ll_fila]
		End If
		ls_Registro +=String(li_copallet, Fill("0", 3))
		ls_Registro += String(iuo_Envase.IfCO)
		
		ll_filadet	=	dw_7.InsertRow(0)
		dw_7.Object.registro[ll_filadet]	=	ls_Registro

		If ExisteArchivo(uo_SelCliente.Codigo,uo_SelPlanta.Codigo,dw_6.Object.defe_guides[ll_fila], al_planilla,String(-1),ls_Instructivo) Then
			Return
		End If
	NEXT
	
	If dw_7.SaveAs(gs_disco+":\GeneradosSAAM\" + ls_Archivo, Text!, False) = -1 Then
		MessageBox("Atención","No se pudo generar el archivo " + ls_Archivo)
	Else
		If dw_Embarcador.Retrieve(uo_SelCliente.Codigo, ll_Guia) > 0 Then
			ls_Archivo	=  "INST" +ls_Instructivo+"-"+ ls_guia + '.xlsx'
			is_Archivo1 = gs_disco+":\GeneradosSAAM\" + ls_Archivo
			dw_Embarcador.SaveAs(gs_disco+":\GeneradosSAAM\" + ls_Archivo, XLSX!, True)
		End If
		
		wf_EnviaMailArchivo()
		MessageBox("Atención", "Archivo " + ls_Archivo + " Generado. Avise a Computación", Exclamation!, Ok!)
		
		ll_filas		=  dw_4.Retrieve(uo_SelCliente.Codigo, uo_SelPlanta.Codigo,al_planilla,ll_guia,'-1',ls_Instructivo)
													  
		If ll_filas = -1 Then
			F_ErrorBaseDatos(sqlca,"Lectura de la Tabla DESPAFRIGOEN")
		ElseIf ll_filas = 0 Then
			MessageBox("Atención", "No hay información ", Exclamation!, Ok!)
		Else		
			FOR ll_fila	= 1 TO ll_filas
				dw_4.SetItem(ll_fila,'defe_estado',1)
				ll_numero 	= dw_4.Object.defe_numero[ll_fila]
				li_cliente 	= dw_4.Object.clie_codigo[ll_fila]
				li_planta		= dw_4.Object.plde_codigo[ll_fila]
		   	NEXT
			wf_actualiza_db(False)
		End If						  
	End If
End If
end subroutine

public subroutine wf_enviamailarchivo ();String			ls_asunto, ls_texto, ls_tipodespa, ls_Archivo
Long			ll_Archivo, ll_Result

str_parms	lstr_parms

If uo_SelCliente.Codigo <> 81 Then Return

SetPointer(HourGlass!)

lstr_parms.string_arg[1]					=	String(1)
lstr_parms.string_arg[2]					=	is_archivo
lstr_parms.string_arg[3]					=	String(1)

ll_Archivo = 1

lstr_parms.string_arg[ll_Archivo+3]		=	gs_disco+":\GeneradosSAAM\" + is_archivo //+ ".txt"

ls_Archivo	= gs_disco+":\GeneradosSAAM\" + is_archivo 
ls_tipodespa	=	Mid(is_archivo,9,1)

iuo_Embarques.Existe(is_Embarque, uo_SelCliente.Codigo, True, Sqlca)
iuo_Embarcador.Existe(iuo_Embarques.Embarcador, True, SqlCa)
iuo_Planta.Existe(uo_SelPlanta.Codigo, True, Sqlca)

ls_Asunto = iuo_Embarques.NombreNave + SEPARADOR + iuo_Embarques.NombrePuerto + SEPARADOR + &
		String(iuo_Embarques.Operacion, '00') + '-' + iuo_Embarques.Codigo + SEPARADOR + String(iuo_Planta.Codigo, '0000') + SEPARADOR + &
		em_nroguia.Text 

ls_texto		 =	 ls_texto + ': '+lstr_parms.string_arg[2]+' con fecha ' + String(Today(),'dd/mm/yyyy')+'.' 

If Upper(ls_tipodespa) = 'P' OR Upper(ls_tipodespa) = 'N' Then
	iuo_Mail.Of_Send(iuo_Planta.Mail,ls_asunto,ls_texto, {ls_Archivo}, 0) 
Else
	iuo_Mail.Of_Send(iuo_Embarcador.Mail, iuo_Planta.Mail,ls_asunto,ls_texto, {ls_Archivo, is_Archivo1},0)
End If	

//If ll_Result < 0 Then
//	messagebox("Error en el envio de mail - Error No" + string(ll_Result),ls_ErrorMsg+ "~r~nIntente enviar correo en forma manual")
//	OpenWithParm(w_correo_archivo_saam, lstr_parms)
//	ii_controlcorreo = 1
//Else
//	Messagebox("Aviso", "Envio de correo exitoso")
//	ii_controlcorreo = 0
//End If

SetPointer(Arrow!)
end subroutine

on w_info_guia_despacho_archivo_saam.create
int iCurrent
call super::create
this.st_1=create st_1
this.st_2=create st_2
this.st_6=create st_6
this.em_nroguia=create em_nroguia
this.gb_3=create gb_3
this.cbx_1=create cbx_1
this.cbx_2=create cbx_2
this.cbx_3=create cbx_3
this.cbx_4=create cbx_4
this.st_3=create st_3
this.st_5=create st_5
this.st_7=create st_7
this.st_8=create st_8
this.em_recibidor=create em_recibidor
this.em_rut=create em_rut
this.em_direccion=create em_direccion
this.cbx_5=create cbx_5
this.st_9=create st_9
this.em_observa=create em_observa
this.dw_guia=create dw_guia
this.cbx_6=create cbx_6
this.cbx_7=create cbx_7
this.cbx_8=create cbx_8
this.st_13=create st_13
this.em_nomdespachador=create em_nomdespachador
this.st_10=create st_10
this.em_tipomv=create em_tipomv
this.em_puerto=create em_puerto
this.em_destino=create em_destino
this.st_11=create st_11
this.st_12=create st_12
this.st_14=create st_14
this.em_nominspector=create em_nominspector
this.cbx_frio=create cbx_frio
this.gb_4=create gb_4
this.st_4=create st_4
this.cbx_id=create cbx_id
this.em_glosaespecial=create em_glosaespecial
this.st_15=create st_15
this.cbx_sdp=create cbx_sdp
this.mle_condicion=create mle_condicion
this.st_22=create st_22
this.st_16=create st_16
this.cbx_archivo=create cbx_archivo
this.cbx_resumen=create cbx_resumen
this.st_17=create st_17
this.em_numsellos=create em_numsellos
this.st_18=create st_18
this.em_ubisellos=create em_ubisellos
this.dw_3=create dw_3
this.em_cansellos=create em_cansellos
this.cbx_valores=create cbx_valores
this.st_19=create st_19
this.em_ciudad=create em_ciudad
this.cbx_csg=create cbx_csg
this.dw_4=create dw_4
this.dw_5=create dw_5
this.dw_6=create dw_6
this.dw_7=create dw_7
this.dw_8=create dw_8
this.dw_tipopallet=create dw_tipopallet
this.dw_etiqueta=create dw_etiqueta
this.pb_imprime=create pb_imprime
this.gb_1=create gb_1
this.st_20=create st_20
this.uo_selcliente=create uo_selcliente
this.uo_selplanta=create uo_selplanta
this.cb_rossi=create cb_rossi
this.dw_error=create dw_error
this.cb_1=create cb_1
this.dw_embarcador=create dw_embarcador
iCurrent=UpperBound(this.Control)
this.Control[iCurrent+1]=this.st_1
this.Control[iCurrent+2]=this.st_2
this.Control[iCurrent+3]=this.st_6
this.Control[iCurrent+4]=this.em_nroguia
this.Control[iCurrent+5]=this.gb_3
this.Control[iCurrent+6]=this.cbx_1
this.Control[iCurrent+7]=this.cbx_2
this.Control[iCurrent+8]=this.cbx_3
this.Control[iCurrent+9]=this.cbx_4
this.Control[iCurrent+10]=this.st_3
this.Control[iCurrent+11]=this.st_5
this.Control[iCurrent+12]=this.st_7
this.Control[iCurrent+13]=this.st_8
this.Control[iCurrent+14]=this.em_recibidor
this.Control[iCurrent+15]=this.em_rut
this.Control[iCurrent+16]=this.em_direccion
this.Control[iCurrent+17]=this.cbx_5
this.Control[iCurrent+18]=this.st_9
this.Control[iCurrent+19]=this.em_observa
this.Control[iCurrent+20]=this.dw_guia
this.Control[iCurrent+21]=this.cbx_6
this.Control[iCurrent+22]=this.cbx_7
this.Control[iCurrent+23]=this.cbx_8
this.Control[iCurrent+24]=this.st_13
this.Control[iCurrent+25]=this.em_nomdespachador
this.Control[iCurrent+26]=this.st_10
this.Control[iCurrent+27]=this.em_tipomv
this.Control[iCurrent+28]=this.em_puerto
this.Control[iCurrent+29]=this.em_destino
this.Control[iCurrent+30]=this.st_11
this.Control[iCurrent+31]=this.st_12
this.Control[iCurrent+32]=this.st_14
this.Control[iCurrent+33]=this.em_nominspector
this.Control[iCurrent+34]=this.cbx_frio
this.Control[iCurrent+35]=this.gb_4
this.Control[iCurrent+36]=this.st_4
this.Control[iCurrent+37]=this.cbx_id
this.Control[iCurrent+38]=this.em_glosaespecial
this.Control[iCurrent+39]=this.st_15
this.Control[iCurrent+40]=this.cbx_sdp
this.Control[iCurrent+41]=this.mle_condicion
this.Control[iCurrent+42]=this.st_22
this.Control[iCurrent+43]=this.st_16
this.Control[iCurrent+44]=this.cbx_archivo
this.Control[iCurrent+45]=this.cbx_resumen
this.Control[iCurrent+46]=this.st_17
this.Control[iCurrent+47]=this.em_numsellos
this.Control[iCurrent+48]=this.st_18
this.Control[iCurrent+49]=this.em_ubisellos
this.Control[iCurrent+50]=this.dw_3
this.Control[iCurrent+51]=this.em_cansellos
this.Control[iCurrent+52]=this.cbx_valores
this.Control[iCurrent+53]=this.st_19
this.Control[iCurrent+54]=this.em_ciudad
this.Control[iCurrent+55]=this.cbx_csg
this.Control[iCurrent+56]=this.dw_4
this.Control[iCurrent+57]=this.dw_5
this.Control[iCurrent+58]=this.dw_6
this.Control[iCurrent+59]=this.dw_7
this.Control[iCurrent+60]=this.dw_8
this.Control[iCurrent+61]=this.dw_tipopallet
this.Control[iCurrent+62]=this.dw_etiqueta
this.Control[iCurrent+63]=this.pb_imprime
this.Control[iCurrent+64]=this.gb_1
this.Control[iCurrent+65]=this.st_20
this.Control[iCurrent+66]=this.uo_selcliente
this.Control[iCurrent+67]=this.uo_selplanta
this.Control[iCurrent+68]=this.cb_rossi
this.Control[iCurrent+69]=this.dw_error
this.Control[iCurrent+70]=this.cb_1
this.Control[iCurrent+71]=this.dw_embarcador
end on

on w_info_guia_despacho_archivo_saam.destroy
call super::destroy
destroy(this.st_1)
destroy(this.st_2)
destroy(this.st_6)
destroy(this.em_nroguia)
destroy(this.gb_3)
destroy(this.cbx_1)
destroy(this.cbx_2)
destroy(this.cbx_3)
destroy(this.cbx_4)
destroy(this.st_3)
destroy(this.st_5)
destroy(this.st_7)
destroy(this.st_8)
destroy(this.em_recibidor)
destroy(this.em_rut)
destroy(this.em_direccion)
destroy(this.cbx_5)
destroy(this.st_9)
destroy(this.em_observa)
destroy(this.dw_guia)
destroy(this.cbx_6)
destroy(this.cbx_7)
destroy(this.cbx_8)
destroy(this.st_13)
destroy(this.em_nomdespachador)
destroy(this.st_10)
destroy(this.em_tipomv)
destroy(this.em_puerto)
destroy(this.em_destino)
destroy(this.st_11)
destroy(this.st_12)
destroy(this.st_14)
destroy(this.em_nominspector)
destroy(this.cbx_frio)
destroy(this.gb_4)
destroy(this.st_4)
destroy(this.cbx_id)
destroy(this.em_glosaespecial)
destroy(this.st_15)
destroy(this.cbx_sdp)
destroy(this.mle_condicion)
destroy(this.st_22)
destroy(this.st_16)
destroy(this.cbx_archivo)
destroy(this.cbx_resumen)
destroy(this.st_17)
destroy(this.em_numsellos)
destroy(this.st_18)
destroy(this.em_ubisellos)
destroy(this.dw_3)
destroy(this.em_cansellos)
destroy(this.cbx_valores)
destroy(this.st_19)
destroy(this.em_ciudad)
destroy(this.cbx_csg)
destroy(this.dw_4)
destroy(this.dw_5)
destroy(this.dw_6)
destroy(this.dw_7)
destroy(this.dw_8)
destroy(this.dw_tipopallet)
destroy(this.dw_etiqueta)
destroy(this.pb_imprime)
destroy(this.gb_1)
destroy(this.st_20)
destroy(this.uo_selcliente)
destroy(this.uo_selplanta)
destroy(this.cb_rossi)
destroy(this.dw_error)
destroy(this.cb_1)
destroy(this.dw_embarcador)
end on

event open;call super::open;Boolean rtn, lb_Cerrar = False

If IsNull(uo_SelCliente.Codigo) Then lb_Cerrar = True
If IsNull(uo_SelPlanta.Codigo) Then lb_Cerrar = True

If lb_Cerrar Then
	Close(This)
Else
	ii_tipo	=	Integer(Message.StringParm)
	
	dw_embarcador.SetTransObject(SQLCA)
	
	cbx_csg.Visible = False
	cbx_csg.Checked = False 
	If gi_vari_rotulada = 1 Then
		cbx_1.Checked	= True
		cbx_1.Enabled	= False
		ii_var=1
	Else
		cbx_1.Checked	= False
		cbx_1.Enabled	= True
		ii_var=0
	 End If	
	
	If gi_prod_rotulado = 1 Then
		cbx_2.Checked	= True
		cbx_2.Enabled	= False
		ii_prod 	=	1
	Else
		cbx_1.Checked	= False
		cbx_1.Enabled	= True
		ii_prod 	=	0
	 End If	
	
	If gi_cali_rotulado = 1 Then
		cbx_3.Checked	= True
		cbx_3.Enabled	= False
		ii_cal 	=	1
	Else
		cbx_3.Checked	= False
		cbx_3.Enabled	= True
		ii_cal 	=	0
	 End If	
	
	If gi_pack_rotulado = 1 Then
		cbx_5.Checked	= True
		cbx_5.Enabled	= False
		ii_pakrot 	=	1
	Else
		cbx_5.Checked	= False
		cbx_5.Enabled	= True
		ii_pakrot 	=	0
	END If	
	
	//ii_var	= gi_vari_rotulada
	cbx_archivo.visible	=	False
	
	is_report		=	'dw_info_guia_despacho_cal'
	
	dw_guia.DataObject = 'dw_info_guia_despacho_cal'
	st_titulo.Text		 =	'Emisión Guia de Despacho'
	
	gb_4.Visible 	= True
	//cbx_6.Visible 	= True
	cbx_7.Visible 	= True
	cbx_8.Visible 	= True
	em_puerto.Enabled = True
	cbx_frio.Visible =  False
	cbx_Resumen.Visible =  True
	
	cbx_id.Visible		= False
	
	cbx_5.Visible = False
	cbx_Valores.Visible = True
	
	uo_SelCliente.Seleccion(False, False)
	uo_SelCliente.Inicia(gi_CodExport)
	
	uo_SelPlanta.Seleccion(False, False)
	uo_SelPlanta.Filtra(1)
	uo_SelPlanta.Inicia(gi_codplanta)
	
	dw_3.SetTransObject(sqlca)
	
	If gi_codplanta <> 81 Then
		em_glosaespecial.Enabled = False
	ELSE	
		em_glosaespecial.Enabled = True
	END If	
	
	iuo_Puertos			=	Create uo_Puertos
	iuo_Embalaje		=	Create uo_Embalajes
	iuo_Envase			=	Create uo_Envases
	iuo_Embarques		=	Create uo_Embarquesprod
	iuo_Embarcador	=	Create uo_Embarcador
	iuo_Planta			=	Create uo_Plantadesp
	iuo_Guia				=	Create uo_GuiaDespacho
	iuo_Despacho		=	Create uo_Despachos
	iuo_Mail				=	Create uo_Mail
	
	If Upper(gstr_us.Nombre) = 'ISTOK.CARVALLO' Or Upper(gstr_us.Nombre) = 'GABRIEL.PONCE'  Or &
		Upper(gstr_us.Nombre) = 'CAMILO.HERNANDEZ' Or Upper(gstr_us.Nombre) = 'JEFFREY.ROBLES' Or &
		Upper(gstr_us.Nombre) = 'NICOLAS.ZUNIGA' Or Upper(gstr_us.Nombre) = 'FABIAN.MIRANDA'  Or &
		Upper(gstr_us.Nombre) = 'DANIELLA.CONTRERAS' Then
		cb_rossi.Visible = True
	End If
	
	pb_acepta.Enabled = False
End If
end event

event resize;//
end event

type pb_excel from w_para_informes`pb_excel within w_info_guia_despacho_archivo_saam
integer x = 2487
integer y = 1152
end type

type st_computador from w_para_informes`st_computador within w_info_guia_despacho_archivo_saam
integer x = 1705
integer width = 1088
end type

type st_usuario from w_para_informes`st_usuario within w_info_guia_despacho_archivo_saam
integer x = 1705
integer width = 1088
end type

type st_temporada from w_para_informes`st_temporada within w_info_guia_despacho_archivo_saam
integer x = 1705
integer width = 1088
end type

type p_logo from w_para_informes`p_logo within w_info_guia_despacho_archivo_saam
string picturename = "\Desarrollo 17\Imagenes\Logos\RBlanco.jpg"
end type

type st_titulo from w_para_informes`st_titulo within w_info_guia_despacho_archivo_saam
integer y = 248
integer width = 1998
string text = "Emisión Guia de Despacho"
end type

type pb_acepta from w_para_informes`pb_acepta within w_info_guia_despacho_archivo_saam
event ue_imprimir ( )
integer x = 2501
integer y = 1832
integer taborder = 250
integer weight = 400
fontcharset fontcharset = ansi!
boolean italic = true
boolean enabled = false
end type

event pb_acepta::clicked;SetPointer(Arrow!)

Integer	fila, li_tipoembq, li_vari, li_emba, li_calib, li_frio, li_marca, li_EmisionGuia
Long		ll_nroguia, ll_Fila, li_control = 0, ll_filpallet, ll_filetiqueta, ll_guia, ll_planilla, ll_filcont
String		ls_cliente, ls_DirectorioAct, ls_Archivo, ls_tipoIns,&
			ls_Ruta, ls_parteemb, ls_texto, ls_Instructivo, ls_embarque
			
If Not DirectoryExists(gs_disco+":\GeneradosSAAM") Then
	MessageBox('Error', 'El directorio para la generacion de archivo: ' + gs_disco+":\GeneradosSAAM" + &
					"~n~nNo existe, favor revisar o comunicarse con informatica, para activar directorio.", StopSign!, Ok!)
	Return
End If

If ii_cli = 1 Then 
	ls_Cliente = uo_SelCliente.NombreRotulado
Else
	ls_Cliente = uo_SelCliente.Nombre
End If

istr_info.titulo	= 'EMISION GUIA DE DESPACHO'
ls_tipoIns 		= String(mle_condicion.Text)
OpenWithParm(vinf2, istr_info)

dw_guia.SetTransObject(sqlca)

ll_NroGuia	=	Long(em_nroguia.Text)

/*Selecciona tipo se salida del embarque*/
	SELECT defe_tiposa, IsNull(defe_guiaem, 0)
		INTO	:li_tipoembq, :li_EmisionGuia
		FROM	dbo.DESPAFRIGOEN 
		WHERE	plde_codigo =	:uo_SelPlanta.Codigo
		AND	clie_codigo	=	:uo_SelCliente.Codigo
		AND	defe_guides	=	:ll_nroguia;
		
If ii_tipo	=	1 Then	
	If ValidaDespacho(uo_SelCliente.Codigo,uo_SelPlanta.Codigo,Long(em_nroguia.Text)) Then Return	
	If cbx_6.Checked Then li_vari = -9	
	If cbx_7.Checked Then li_emba = -9
	If cbx_8.Checked Then li_calib = -9	
	If cbx_Resumen.Checked Then li_control = 1
		
	If cbx_valores.Checked Then  		
		If ii_tipo = 1 Then
			OpenWithParm(vinf, istr_info)
			vinf.dw_1.DataObject	= "dw_info_guiadespacho_validadatos"
			vinf.dw_1.SetTransObject(sqlca)
					
			fila = vinf.dw_1.Retrieve(uo_SelCliente.Codigo, uo_SelPlanta.Codigo, ll_nroguia,Integer(istr_mant.argumento[25]),ii_var, ii_prod, ii_cal,li_vari,li_emba,li_calib,li_control, iuo_Despacho.Despacho)
			
			If fila = -1 Then
				MessageBox( "Error en Base de Datos", "Se ha producido un error en Base " + &
								"de datos : ~n" + sqlca.SQLErrText, StopSign!, Ok!)
			ElseIf fila = 0 Then				
				MessageBox("Atención","Valores de Embarques Correctos.")
				Return
			ElseIf fila > 0 Then
				F_Membrete(vinf.dw_1)
				If gs_Ambiente <> 'Windows' Then F_ImprimeInformePdf(vinf1.dw_1, istr_info.titulo)
				MessageBox("Atención","Faltan Datos en Tabla EmbarValores.")
				Return
			End If					 
		End If	
	End If
	
	If ii_tipo = 1 Then
		If IsNull(uo_SelCliente.FormatoGuia) OR uo_SelCliente.FormatoGuia = '' Then
			vinf2.dw_1.DataObject = is_report
		Else
			vinf2.dw_1.DataObject	= uo_SelCliente.FormatoGuia
			dw_guia.DataObject		= uo_SelCliente.FormatoGuia		
		End If
	End If	

	vinf2.dw_1.SetTransObject(sqlca)
	
	fila = vinf2.dw_1.Retrieve(uo_SelCliente.Codigo, uo_SelPlanta.Codigo, ll_nroguia,Integer(istr_mant.argumento[25]),ii_var, ii_prod, ii_cal,li_vari,li_emba,li_calib,li_control, iuo_Despacho.Despacho)
	fila = dw_guia.Retrieve(uo_SelCliente.Codigo, uo_SelPlanta.Codigo, ll_nroguia,Integer(istr_mant.argumento[25]),ii_var, ii_prod, ii_cal,li_vari,li_emba,li_calib,li_control, iuo_Despacho.Despacho)
	
	ls_DirectorioAct=GetCurrentDirectory()
	ls_Archivo	=	ls_DirectorioAct + '\Guía Nº'+String(ll_nroguia)+' '+String(today(),'yyyymmdd')+'.pdf'
	
	is_asunto = String(ll_nroguia)
	is_archivo = ls_Archivo
	
	If cbx_Resumen.Checked Then vinf2.dw_1.Modify("DataWindow.Summary.Height.AutoSize")	 
/*
Estado de impresion de guia
*/
  UPDATE dbo.despafrigoguias SET
    degd_estado = 1
    WHERE clie_codigo = :uo_SelCliente.Codigo
    AND plde_codigo   = :uo_SelPlanta.Codigo
    AND defe_numero   = :il_despacho
	 AND defe_guides   = :ll_nroguia;
	 COMMIT;
End If

iuo_Embarques.Existe(is_embarque, uo_SelCliente.Codigo, False, Sqlca)
iuo_Embarcador.Existe(iuo_Embarques.Embarcador, False, Sqlca)

If fila = -1 Then
	MessageBox( "Error en Base de Datos", "Se ha producido un error en Base de datos : ~n" + sqlca.SQLErrText, StopSign!, Ok!)
ElseIf fila = 0 Then
	MessageBox( "No Existe información", "No existe información para este informe.", StopSign!, Ok!)
Else
	F_Membrete(vinf2.dw_1)
	
	Despacho(uo_SelCliente.Codigo, uo_SelPlanta.Codigo, ll_NroGuia)
	
	If ii_tipo	=	1 Then
		ls_parteemb = Right(is_embarque, 1)
		is_parteemb = Right(is_embarque, 1)
		
		If (ii_tipoemb = 7 Or ii_tipoemb = 8 Or ii_tipoemb = 9 Or ii_tipoemb = 33)  Then	
			If ii_controlsaam = 0 Then
				If iuo_Embarcador.ArchivoPlano = 1 Then wf_GeneraGuia_ws()
				wf_GeneraArchivo()
			End If
		End If	
	End If	
	
	If ii_tipo	=	1 Or ii_tipo	=	3 Then
		If li_tipoembq = 7 Or li_tipoembq = 8 Or li_tipoembq = 9 Then
			For ll_Fila	=  1 To fila
				vinf2.dw_1.SetItem(ll_Fila, "embc_nombre", em_recibidor.text)
				vinf2.dw_1.SetItem(ll_Fila, "embc_nrorut", em_rut.text)
				vinf2.dw_1.SetItem(ll_Fila, "embc_direcc", em_direccion.text)
				vinf2.dw_1.SetItem(ll_Fila, "embc_ciudad", em_ciudad.Text)
			Next
		End If
		
		If li_tipoembq = 11 Then
			For ll_Fila	=  1 To fila
				If em_recibidor.text <> '' Then vinf2.dw_1.SetItem(ll_Fila, "embc_nombre", em_recibidor.text)
				If em_rut.text <> '' Then vinf2.dw_1.SetItem(ll_Fila, "embc_nrorut", em_rut.text)
				If em_direccion.text <> '' Then vinf2.dw_1.SetItem(ll_Fila, "embc_direcc", em_direccion.text)
				If em_ciudad.Text <> '' Then vinf2.dw_1.SetItem(ll_Fila, "embc_ciudad", em_ciudad.Text)
			Next
		End If
	End If
	
	If ii_tipo	=	1 Then
		vinf2.dw_1.Modify("t_guia.text = '"		+ em_nroguia.Text + "'")
		vinf2.dw_1.Modify("t_puerto.text = '" 		+ em_puerto.Text + "'")
		vinf2.dw_1.Modify("t_numsellos.text = '"	+ em_numsellos.text + "'")
		vinf2.dw_1.Modify("t_observa.text = '"	+ em_observa.text + "'")
		vinf2.dw_1.Modify("t_cansellos.text = '"	+ em_cansellos.text + "'")
		vinf2.dw_1.Modify("t_ubisellos.text = '"	+ em_ubisellos.text + "'")

//		
//		Emite Guia Despacho
//			
		iuo_Guia.of_SetPuertoDestino(em_puerto.Text)
		iuo_Guia.of_SetNumeroSellos(em_numsellos.Text)
		iuo_Guia.of_SetGlosaGD(em_observa.Text)
		iuo_Guia.of_SetCantidadSellos(em_cansellos.Text)
		iuo_Guia.of_SetUbicacionSellos(em_ubisellos.Text)
		
		If li_EmisionGuia = 3 Or li_EmisionGuia = 0 Then 
			If iuo_Guia.of_EmiteGuia(uo_SelCliente.Codigo, uo_SelPlanta.Codigo, ll_NroGuia, False,ii_var, ii_prod, ii_cal,li_vari,li_emba,li_calib,li_control, 1, iuo_Despacho.Despacho)  > 0 Then
				If Not iuo_Guia.of_GeneraLibroGuia(1) Then 
					MessageBox('Alerta', 'No se pudo actualziar Libro de guias de despacho.', Information!, OK!)
				End If
				iuo_Guia.of_ActualizaEstadoGD(1, uo_SelCliente.Codigo, uo_SelPlanta.Codigo, ll_NroGuia, 1, SQLCA)
				iuo_Guia.of_RecuperaPDF(ll_NroGuia,dw_guia.Object.defe_fecdes[1], 1)
			End If
		Else
			iuo_Guia.of_RecuperaPDF(ll_NroGuia, dw_guia.Object.defe_fecdes[1], 1)
		End If
		
		iuo_Despacho.of_ActualizaEstado(1, uo_SelCliente.Codigo, uo_SelPlanta.Codigo, ll_NroGuia, SQLCA)
		
		vinf2.dw_1.SaveAs(gs_disco+":\GeneradosSAAM\"+'GD' +String(uo_SelCliente.Codigo)+''+String(uo_SelPlanta.Codigo)+''+String(ll_nroguia)+'.PDF', PDF!, TRUE)
		is_archivoguias = gs_disco+":\GeneradosSAAM\"+'GD' +String(uo_SelCliente.Codigo)+''+String(uo_SelPlanta.Codigo)+''+String(ll_nroguia)
		EnviaGuiaSaam()

		If uo_SelPlanta.Codigo = 81 Then vinf2.dw_1.Modify("t_glosa.text = '" + em_GlosaEspecial.Text + "'")
	End If
	
	If gs_Ambiente <> 'Windows' Then F_ImprimeInformePdf(vinf.dw_1, istr_info.titulo)
	vinf2.dw_1.GroupCalc()
End If

pb_acepta.Enabled = False

SetPointer(Arrow!)				
end event

type pb_salir from w_para_informes`pb_salir within w_info_guia_despacho_archivo_saam
integer x = 2505
integer y = 2104
integer taborder = 260
end type

type st_1 from statictext within w_info_guia_despacho_archivo_saam
integer x = 594
integer y = 492
integer width = 270
integer height = 68
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
boolean enabled = false
string text = "Planta"
boolean focusrectangle = false
end type

type st_2 from statictext within w_info_guia_despacho_archivo_saam
integer x = 594
integer y = 576
integer width = 270
integer height = 72
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
string text = "Nro. Guia"
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type st_6 from statictext within w_info_guia_despacho_archivo_saam
integer x = 594
integer y = 396
integer width = 270
integer height = 68
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
string text = "Cliente"
boolean focusrectangle = false
end type

type em_nroguia from editmask within w_info_guia_despacho_archivo_saam
integer x = 878
integer y = 572
integer width = 370
integer height = 80
integer taborder = 30
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 16777215
alignment alignment = center!
borderstyle borderstyle = stylelowered!
string mask = "########"
end type

event modified;IF ExisteGuia(Long(This.Text)) = False THEN
	This.SetFocus()
END IF
end event

type gb_3 from groupbox within w_info_guia_despacho_archivo_saam
integer x = 288
integer y = 672
integer width = 654
integer height = 356
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 553648127
end type

type cbx_1 from checkbox within w_info_guia_despacho_archivo_saam
integer x = 302
integer y = 700
integer width = 594
integer height = 80
integer taborder = 60
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
string text = "Variedad Rotulada"
boolean checked = true
end type

event clicked;IF This.Checked THEN
	ii_var =	1	
ELSE
	ii_var =	0
END IF

end event

type cbx_2 from checkbox within w_info_guia_despacho_archivo_saam
integer x = 302
integer y = 780
integer width = 594
integer height = 80
integer taborder = 70
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
string text = "Productor Rotulado"
boolean checked = true
end type

event clicked;IF This.Checked THEN
	ii_prod =	1	
ELSE
	ii_prod =	0
END IF
end event

type cbx_3 from checkbox within w_info_guia_despacho_archivo_saam
integer x = 302
integer y = 860
integer width = 594
integer height = 80
integer taborder = 80
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
string text = "Calidad Rotulada"
end type

event clicked;IF This.Checked THEN
	ii_cal =	1	
ELSE
	ii_cal =	0
END IF
end event

type cbx_4 from checkbox within w_info_guia_despacho_archivo_saam
integer x = 302
integer y = 940
integer width = 594
integer height = 80
integer taborder = 90
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
string text = "Cliente Rotulado"
end type

event clicked;IF This.Checked THEN
	ii_cli =	1	
ELSE
	ii_cli =	0
END IF

end event

type st_3 from statictext within w_info_guia_despacho_archivo_saam
integer x = 251
integer y = 1060
integer width = 1998
integer height = 1228
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 16711680
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type st_5 from statictext within w_info_guia_despacho_archivo_saam
integer x = 274
integer y = 1092
integer width = 590
integer height = 64
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
string text = "Recibidor"
boolean focusrectangle = false
end type

type st_7 from statictext within w_info_guia_despacho_archivo_saam
integer x = 274
integer y = 1184
integer width = 590
integer height = 64
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
string text = "Rut"
boolean focusrectangle = false
end type

type st_8 from statictext within w_info_guia_despacho_archivo_saam
integer x = 274
integer y = 1276
integer width = 590
integer height = 64
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
string text = "Dirección"
boolean focusrectangle = false
end type

type em_recibidor from editmask within w_info_guia_despacho_archivo_saam
integer x = 846
integer y = 1076
integer width = 1358
integer height = 80
integer taborder = 140
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
boolean enabled = false
textcase textcase = upper!
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = stringmask!
end type

type em_rut from editmask within w_info_guia_despacho_archivo_saam
integer x = 846
integer y = 1168
integer width = 480
integer height = 88
integer taborder = 150
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
boolean enabled = false
alignment alignment = center!
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = stringmask!
string mask = "###.###.###-a"
end type

type em_direccion from editmask within w_info_guia_despacho_archivo_saam
integer x = 846
integer y = 1260
integer width = 1358
integer height = 88
integer taborder = 160
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
boolean enabled = false
textcase textcase = upper!
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = stringmask!
end type

type cbx_5 from checkbox within w_info_guia_despacho_archivo_saam
integer x = 1161
integer y = 2768
integer width = 594
integer height = 80
integer taborder = 100
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 553648127
string text = "Packing Rotulado"
end type

event clicked;IF This.Checked THEN
	ii_pakrot =	1	
ELSE
	ii_pakrot =	0
END IF

end event

type st_9 from statictext within w_info_guia_despacho_archivo_saam
integer x = 274
integer y = 1372
integer width = 590
integer height = 64
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
string text = "Observaciones G.D."
boolean focusrectangle = false
end type

type em_observa from editmask within w_info_guia_despacho_archivo_saam
integer x = 846
integer y = 1352
integer width = 1358
integer height = 88
integer taborder = 170
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
textcase textcase = upper!
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = stringmask!
string minmax = "~~200"
end type

type dw_guia from datawindow within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 3237
integer y = 104
integer width = 192
integer height = 148
boolean bringtotop = true
string title = "none"
end type

type cbx_6 from checkbox within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 2437
integer y = 924
integer width = 571
integer height = 80
integer taborder = 110
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
boolean enabled = false
string text = "Consolida Variedad"
end type

type cbx_7 from checkbox within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 1015
integer y = 700
integer width = 581
integer height = 80
integer taborder = 120
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
string text = "Consolida Embalaje"
end type

type cbx_8 from checkbox within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 1015
integer y = 780
integer width = 521
integer height = 80
integer taborder = 130
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
string text = "Consolida Calibre"
end type

type st_13 from statictext within w_info_guia_despacho_archivo_saam
integer x = 274
integer y = 1460
integer width = 590
integer height = 84
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
boolean enabled = false
string text = "Nombre Responsable"
boolean focusrectangle = false
end type

type em_nomdespachador from editmask within w_info_guia_despacho_archivo_saam
event getfocus pbm_ensetfocus
integer x = 846
integer y = 1444
integer width = 1358
integer height = 88
integer taborder = 180
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 16777215
textcase textcase = upper!
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = stringmask!
string displaydata = "$"
end type

type st_10 from statictext within w_info_guia_despacho_archivo_saam
integer x = 274
integer y = 1548
integer width = 590
integer height = 84
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
boolean enabled = false
string text = "Tipo Movto."
boolean focusrectangle = false
end type

type em_tipomv from editmask within w_info_guia_despacho_archivo_saam
event getfocus pbm_ensetfocus
integer x = 846
integer y = 1536
integer width = 1358
integer height = 88
integer taborder = 190
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 16777215
string text = "EXPORTACION"
textcase textcase = upper!
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = stringmask!
string displaydata = "$"
end type

type em_puerto from editmask within w_info_guia_despacho_archivo_saam
event getfocus pbm_ensetfocus
integer x = 846
integer y = 1628
integer width = 1358
integer height = 88
integer taborder = 200
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 16777215
boolean enabled = false
textcase textcase = upper!
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = stringmask!
string displaydata = "$"
end type

type em_destino from editmask within w_info_guia_despacho_archivo_saam
event getfocus pbm_ensetfocus
integer x = 846
integer y = 1720
integer width = 1358
integer height = 88
integer taborder = 210
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 16777215
boolean enabled = false
textcase textcase = upper!
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = stringmask!
string displaydata = "$"
end type

type st_11 from statictext within w_info_guia_despacho_archivo_saam
integer x = 274
integer y = 1636
integer width = 590
integer height = 84
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
boolean enabled = false
string text = "Puerto"
boolean focusrectangle = false
end type

type st_12 from statictext within w_info_guia_despacho_archivo_saam
integer x = 274
integer y = 1724
integer width = 590
integer height = 84
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
boolean enabled = false
string text = "País Destino"
boolean focusrectangle = false
end type

type st_14 from statictext within w_info_guia_despacho_archivo_saam
integer x = 274
integer y = 1828
integer width = 590
integer height = 84
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
boolean enabled = false
string text = "Inspector SAG"
boolean focusrectangle = false
end type

type em_nominspector from editmask within w_info_guia_despacho_archivo_saam
event getfocus pbm_ensetfocus
integer x = 846
integer y = 1812
integer width = 1358
integer height = 88
integer taborder = 220
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 16777215
textcase textcase = upper!
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = stringmask!
string displaydata = "$"
end type

type cbx_frio from checkbox within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 494
integer y = 2624
integer width = 402
integer height = 88
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 553648127
string text = "Tipo Frío"
end type

type gb_4 from groupbox within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 978
integer y = 672
integer width = 654
integer height = 356
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
end type

type st_4 from statictext within w_info_guia_despacho_archivo_saam
integer x = 251
integer y = 372
integer width = 1998
integer height = 296
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 16711680
boolean enabled = false
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type cbx_id from checkbox within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 667
integer y = 2736
integer width = 151
integer height = 80
integer taborder = 50
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 553648127
string text = "ID"
end type

type em_glosaespecial from editmask within w_info_guia_despacho_archivo_saam
event getfocus pbm_ensetfocus
integer x = 846
integer y = 1916
integer width = 1358
integer height = 88
integer taborder = 230
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 16777215
boolean enabled = false
string text = "Traslado de Mercadería desde Frigorífico las delicias ubicado en Camino La Compañía s/n Callejón Las Delicias Codegua de COMERCIAL RIO BLANCO LAS DELICIAS SEGÚN CONTRATO PRESTACIÓN DE SERVICIOS a Interior Recintos Portuarios."
textcase textcase = upper!
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = stringmask!
string displaydata = "$"
end type

type st_15 from statictext within w_info_guia_despacho_archivo_saam
integer x = 274
integer y = 1916
integer width = 590
integer height = 84
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
boolean enabled = false
string text = "Glosa Especial"
boolean focusrectangle = false
end type

type cbx_sdp from checkbox within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 466
integer y = 2736
integer width = 206
integer height = 80
integer taborder = 40
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 553648127
string text = "SDP"
end type

event clicked;//IF cbx_sdp.Checked THEN
//	cbx_csg.Checked = False
//END IF	
end event

type mle_condicion from multilineedit within w_info_guia_despacho_archivo_saam
integer x = 846
integer y = 1996
integer width = 1358
integer height = 88
integer taborder = 240
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 16777215
string text = "FRESCO"
textcase textcase = upper!
integer limit = 20
borderstyle borderstyle = stylelowered!
end type

type st_22 from statictext within w_info_guia_despacho_archivo_saam
integer x = 274
integer y = 2004
integer width = 590
integer height = 84
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
boolean enabled = false
string text = "Condición"
boolean focusrectangle = false
end type

type st_16 from statictext within w_info_guia_despacho_archivo_saam
integer x = 251
integer y = 2288
integer width = 2002
integer height = 96
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
long backcolor = 16711680
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type cbx_archivo from checkbox within w_info_guia_despacho_archivo_saam
integer x = 311
integer y = 2640
integer width = 2057
integer height = 80
integer taborder = 50
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 553648127
string text = "Archivo Resumen de los Predios, Provincias, Comunas y Cuarteles"
end type

type cbx_resumen from checkbox within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 1687
integer y = 700
integer width = 512
integer height = 80
integer taborder = 50
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
string text = "Resumen Pallet"
boolean checked = true
end type

type st_17 from statictext within w_info_guia_despacho_archivo_saam
integer x = 274
integer y = 2100
integer width = 590
integer height = 76
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
boolean enabled = false
string text = "Números de Sellos"
boolean focusrectangle = false
end type

type em_numsellos from editmask within w_info_guia_despacho_archivo_saam
event getfocus pbm_ensetfocus
integer x = 846
integer y = 2096
integer width = 1358
integer height = 84
integer taborder = 130
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 16777215
textcase textcase = upper!
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = stringmask!
string displaydata = "$"
end type

type st_18 from statictext within w_info_guia_despacho_archivo_saam
integer x = 270
integer y = 2196
integer width = 590
integer height = 84
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
boolean enabled = false
string text = "Cantidad - Ubicación "
boolean focusrectangle = false
end type

type em_ubisellos from editmask within w_info_guia_despacho_archivo_saam
event getfocus pbm_ensetfocus
integer x = 1010
integer y = 2188
integer width = 1193
integer height = 84
integer taborder = 140
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 16777215
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = stringmask!
string displaydata = "$"
end type

type dw_3 from datawindow within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 2843
integer y = 260
integer width = 192
integer height = 148
integer taborder = 150
boolean bringtotop = true
string title = "none"
string dataobject = "dw_ubicacionessellossag"
end type

type em_cansellos from editmask within w_info_guia_despacho_archivo_saam
event getfocus pbm_ensetfocus
integer x = 846
integer y = 2188
integer width = 160
integer height = 84
integer taborder = 140
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 16777215
alignment alignment = center!
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = stringmask!
string displaydata = "$"
end type

type cbx_valores from checkbox within w_info_guia_despacho_archivo_saam
integer x = 841
integer y = 2304
integer width = 827
integer height = 68
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
string text = "Revisa Valores de Embarque"
end type

type st_19 from statictext within w_info_guia_despacho_archivo_saam
integer x = 1422
integer y = 1184
integer width = 256
integer height = 64
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
string text = "Ciudad"
boolean focusrectangle = false
end type

type em_ciudad from editmask within w_info_guia_despacho_archivo_saam
integer x = 1632
integer y = 1168
integer width = 571
integer height = 88
integer taborder = 180
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 33554432
textcase textcase = upper!
borderstyle borderstyle = stylelowered!
maskdatatype maskdatatype = stringmask!
string minmax = "~~200"
end type

type cbx_csg from checkbox within w_info_guia_despacho_archivo_saam
integer x = 466
integer y = 2808
integer width = 402
integer height = 80
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 553648127
string text = "CSG"
end type

event clicked;//IF cbx_csg.Checked THEN
//	cbx_sdp.Checked = False
//END IF
end event

type dw_4 from datawindow within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 2373
integer y = 320
integer width = 192
integer height = 148
integer taborder = 150
boolean bringtotop = true
string title = "none"
string dataobject = "dw_gene_archivo_saam_estado_nuevo_guia"
end type

type dw_5 from datawindow within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 2843
integer y = 416
integer width = 192
integer height = 148
integer taborder = 70
boolean bringtotop = true
string title = "none"
string dataobject = "dw_controla_prediocuartel_guia"
end type

type dw_6 from datawindow within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 3040
integer y = 104
integer width = 192
integer height = 148
integer taborder = 30
boolean bringtotop = true
string title = "none"
string dataobject = "dw_info_archivo_saam_packing_nuevo"
end type

type dw_7 from datawindow within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 2843
integer y = 104
integer width = 192
integer height = 148
integer taborder = 10
boolean bringtotop = true
string title = "none"
string dataobject = "dw_gene_archivo_saam_plano_nuevo"
end type

type dw_8 from datawindow within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 3237
integer y = 416
integer width = 192
integer height = 148
integer taborder = 180
boolean bringtotop = true
string title = "none"
string dataobject = "dw_palleteliminados_despacho"
end type

type dw_tipopallet from datawindow within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 3040
integer y = 260
integer width = 192
integer height = 148
integer taborder = 100
boolean bringtotop = true
string title = "none"
string dataobject = "dw_validatipopallet"
end type

type dw_etiqueta from datawindow within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 3040
integer y = 416
integer width = 192
integer height = 148
integer taborder = 180
boolean bringtotop = true
string title = "none"
string dataobject = "dw_validaetiqueta"
end type

type pb_imprime from picturebutton within w_info_guia_despacho_archivo_saam
integer x = 2501
integer y = 1640
integer width = 302
integer height = 140
integer taborder = 180
boolean bringtotop = true
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean enabled = false
string text = "Validación"
end type

event clicked;SetPointer(Arrow!)

Integer	fila, li_planta, li_cliente,li_tipoembq, li_vari, li_emba, li_calib, li_frio, li_marca
Long		ll_nroguia, ll_Fila, li_control, ll_filpallet, ll_filetiqueta, ll_guia, ll_planilla, ll_filcont
String	ls_cliente, ls_planta, ls_DirectorioAct, ls_Archivo, ls_FtoGuiaDespa, ls_tipoIns,&
			ls_Ruta, ls_parteemb, ls_texto, ls_Instructivo, ls_embarque

li_cliente	=	uo_SelCliente.Codigo
If ii_cli = 1 Then
	
  SELECT clie_rnombr, clie_ftodes
    INTO :ls_cliente  , :ls_FtoGuiaDespa
    FROM dbo.clientesprod  
   WHERE clie_codigo= :li_cliente ;
Else
	//ls_cliente	=	idwc_cliente.GetItemString(idwc_cliente.GetRow(),"clie_nombre")
	SELECT clie_nombre , clie_ftodes 
    INTO :ls_cliente  , :ls_FtoGuiaDespa
    FROM dbo.clientesprod  
   WHERE clie_codigo= :li_cliente ;
	
End If
ls_planta	=	uo_SelPlanta.Nombre

istr_info.titulo	= 'EMISION GUIA DE DESPACHO'

ls_tipoIns = String(mle_condicion.Text)

OpenWithParm(vinf1, istr_info)

dw_guia.SetTransObject(sqlca)

li_planta		=	uo_SelPlanta.Codigo
ll_nroguia	=	Long(em_nroguia.Text)

	SELECT defe_tiposa
		INTO	:li_tipoembq
		FROM	dbo.DESPAFRIGOEN 
		WHERE	plde_codigo =	:li_planta
		AND	clie_codigo	=	:li_cliente
		AND	defe_guides	=	:ll_nroguia;

If ii_tipo	=	1 Then
	If validadespacho(uo_SelCliente.Codigo,uo_SelPlanta.Codigo,Long(em_nroguia.Text)) Then
		Return
	End If
	
	If cbx_6.Checked Then
		li_vari = -9
	End If	
	
	If cbx_7.Checked Then
		li_emba = -9
	End If
	
	If cbx_8.Checked Then
		li_calib = -9
	End If
	
	If cbx_Resumen.Checked Then
		li_control = 1
	Else	
		li_control = 0
	End If
		
	If cbx_valores.Checked Then  		
		If ii_tipo = 1 Then
			OpenWithParm(vinf, istr_info)
			vinf.dw_1.DataObject	= "dw_info_guiadespacho_validadatos"
			vinf.dw_1.SetTransObject(sqlca)
					
			fila = vinf.dw_1.Retrieve(li_cliente, li_planta, ll_nroguia,Integer(istr_mant.argumento[25]),ii_var, ii_prod, ii_cal,li_vari,li_emba,li_calib,li_control, iuo_Despacho.Despacho)
			
			If fila = -1 Then
				MessageBox( "Error en Base de Datos", "Se ha producido un error en Base " + &
								"de datos : ~n" + sqlca.SQLErrText, StopSign!, Ok!)
			ElseIf fila = 0 Then				
				MessageBox("Atención","Valores de Embarques Correctos.")
				Return
			ElseIf fila > 0 Then
				F_Membrete(vinf.dw_1)
				If gs_Ambiente <> 'Windows' Then F_ImprimeInformePdf(vinf1.dw_1, istr_info.titulo)
				MessageBox("Atención","Faltan Datos en Tabla EmbarValores.")
				Return
			End If					 
		End If	
	End If	
	If ii_tipo = 1 Then
		If li_cliente <> 590  Then
			If IsNull(ls_FtoGuiaDespa) OR ls_FtoGuiaDespa = '' Then
				vinf1.dw_1.DataObject = is_report
			Else
				vinf1.dw_1.DataObject	= ls_FtoGuiaDespa
			End If
		Else	
			If ls_FtoGuiaDespa = '' Then
				vinf1.dw_1.DataObject = 'dw_info_guia_despacho_lirios'
			Else
				vinf1.dw_1.DataObject	= ls_FtoGuiaDespa
			End If
		End If
	End If	

	vinf1.dw_1.SetTransObject(sqlca)
	fila = vinf1.dw_1.Retrieve(li_cliente, li_planta, ll_nroguia,Integer(istr_mant.argumento[25]),ii_var, ii_prod, ii_cal,li_vari,li_emba,li_calib,li_control, iuo_Despacho.Despacho)
	
	If cbx_Resumen.Checked Then
		vinf1.dw_1.ModIfy("DataWindow.Summary.Height.AutoSize")
	Else	
		vinf1.dw_1.ModIfy("DataWindow.Summary.Height = 72")
	End If
End If

If fila = -1 Then
	MessageBox( "Error en Base de Datos", "Se ha producido un error en Base " + &
			   	"de datos : ~n" + sqlca.SQLErrText, StopSign!, Ok!)
ElseIf fila = 0 Then
	MessageBox( "No Existe información", "No existe información para este informe.", StopSign!, Ok!)
 Else
	F_Membrete(vinf1.dw_1)
	
	If ii_tipo	=	1 Then
		If li_tipoembq = 7 OR li_tipoembq = 8 OR li_tipoembq = 9 Then
			FOR ll_Fila	=  1 TO fila
				vinf1.dw_1.SetItem(ll_Fila, "embc_nombre", em_recibidor.text)
				vinf1.dw_1.SetItem(ll_Fila, "embc_nrorut", em_rut.text)
				vinf1.dw_1.SetItem(ll_Fila, "embc_direcc", em_direccion.text)
				vinf1.dw_1.SetItem(ll_Fila, "embc_ciudad", em_ciudad.Text)
			NEXT			
		End If
		
		If li_tipoembq = 11 Then
			FOR ll_Fila	=  1 TO fila
				If em_recibidor.text <> '' Then
					vinf1.dw_1.SetItem(ll_Fila, "embc_nombre", em_recibidor.text)
				End If	
				If em_rut.text <> '' Then
					vinf1.dw_1.SetItem(ll_Fila, "embc_nrorut", em_rut.text)
				End If	
				If em_direccion.text <> '' Then
					vinf1.dw_1.SetItem(ll_Fila, "embc_direcc", em_direccion.text)
				End If
				If em_ciudad.Text <> '' Then
					vinf1.dw_1.SetItem(ll_Fila, "embc_ciudad", em_ciudad.Text)
				End If	
			NEXT			
		End If
	End If
	
	If ii_tipo	=	1 Then
		vinf1.dw_1.ModIfy("t_guia.text = '" + em_nroguia.Text + "'")
		vinf1.dw_1.SaveAs("C:\GeneradosSaam\"+'GD' +String(li_cliente)+''+String(li_planta)+''+String(ll_nroguia)+'.PDF', PDF!, TRUE)
		vinf1.dw_1.ModIfy("t_puerto.text = '" + em_puerto.Text + "'")
		
		If li_planta = 81 Then
			vinf1.dw_1.ModIfy("t_glosa.text = '" + em_glosaespecial.Text + "'")
		End If	
		
		If li_cliente = 590 Then
			vinf1.dw_1.ModIfy("t_tipomv.text = '" + em_tipomv.Text + "'")
			vinf1.dw_1.ModIfy("t_nomrespon.text = '" + em_nomdespachador.Text + "'")
			vinf1.dw_1.ModIfy("t_puerto.text = '" + em_puerto.Text + "'")
			vinf1.dw_1.ModIfy("t_destino.text = '" + em_destino.Text + "'")
		End If	
	End If
	vinf1.dw_1.ModIfy("t_observa.text = '" + em_observa.text + "'")	
	
	vinf1.dw_1.ModIfy("t_cansellos.text = '" + em_cansellos.text + "'")
	vinf1.dw_1.ModIfy("t_ubisellos.text = '" + em_ubisellos.text + "'")
	vinf1.dw_1.ModIfy("t_numsellos.text = '" + em_numsellos.text + "'")
	
	If gs_Ambiente <> 'Windows' Then F_ImprimeInformePdf(vinf1.dw_1, istr_info.titulo)
	pb_acepta.Enabled = True
	vinf1.dw_1.GroupCalc()
End If

SetPointer(Arrow!)				
end event

type gb_1 from groupbox within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 1669
integer y = 672
integer width = 535
integer height = 356
integer taborder = 40
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long textcolor = 16777215
long backcolor = 553648127
end type

type st_20 from statictext within w_info_guia_despacho_archivo_saam
integer x = 251
integer y = 676
integer width = 1998
integer height = 384
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Tahoma"
long backcolor = 16711680
boolean enabled = false
boolean border = true
borderstyle borderstyle = styleraised!
boolean focusrectangle = false
end type

type uo_selcliente from uo_seleccion_clientesprod within w_info_guia_despacho_archivo_saam
event destroy ( )
integer x = 878
integer y = 380
integer height = 96
integer taborder = 30
boolean bringtotop = true
end type

on uo_selcliente.destroy
call uo_seleccion_clientesprod::destroy
end on

type uo_selplanta from uo_seleccion_plantas within w_info_guia_despacho_archivo_saam
event destroy ( )
integer x = 878
integer y = 476
integer height = 96
integer taborder = 30
boolean bringtotop = true
end type

on uo_selplanta.destroy
call uo_seleccion_plantas::destroy
end on

event ue_cambio;call super::ue_cambio;If This.Codigo <> 81 Then
	em_glosaespecial.Enabled = False
Else
	em_glosaespecial.Enabled = True
End If
end event

type cb_rossi from commandbutton within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 2341
integer y = 816
integer width = 594
integer height = 108
integer taborder = 40
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean enabled = false
string text = "WS Embarcador"
end type

event clicked;//uo_ws_embarcador	luo_Rossi
//luo_Rossi	=	Create uo_ws_embarcador
//
//luo_Rossi.of_SetURL(iuo_Embarcador.URL)
//luo_Rossi.of_setheaders(iuo_Embarcador.Header)
//
//luo_Rossi.of_CargaGuia(uo_SelCliente.Codigo, uo_SelPlanta.Codigo, al_planilla, is_embarque, dw_error)
//
//If dw_error.RowCount() > 0 Then dw_error.Visible = True
//
//Destroy luo_Rossi

SetPointer(HourGlass!)

If em_nroguia.Text = '' Or IsNull(em_nroguia.Text) Then 
	MessageBox('Atencion', 'Debe seleccionar una guia de despacho.', StopSign!, OK!)
	Return
Else
	wf_GeneraGuia_ws()
End If

SetPointer(Arrow!)
end event

type dw_error from uo_dw within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 265
integer y = 1080
integer width = 2336
integer taborder = 11
boolean bringtotop = true
string dataobject = "dw_errorjson"
boolean resizable = true
end type

event buttonclicked;call super::buttonclicked;String ls_Columna

ls_Columna = dwo.Name

Choose Case ls_Columna
	Case 'b_cerrar'
		This.Reset()
		This.Visible = False
		
End Choose
end event

type cb_1 from commandbutton within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 2341
integer y = 712
integer width = 402
integer height = 112
integer taborder = 130
boolean bringtotop = true
integer textsize = -10
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
boolean enabled = false
string text = "none"
end type

event clicked;uo_GuiaDespacho		luo_Guia
uo_Despachos			luo_Despacho
DataStore				lds_Guia
Long						ll_Fila, ll_FilaD
String						ls_numsel = '', ls_ubisel = ''

luo_Guia			=	Create uo_GuiaDespacho
luo_Despacho	=	Create uo_Despachos
lds_Guia			=	Create DataStore

lds_Guia.DataObject = 'dw_guia_cabrini'
lds_Guia.SetTransObject(SQLCA)
lds_Guia.Retrieve()

For ll_Fila = 1 to lds_Guia.RowCount()
	 	ll_FilaD = dw_3.Retrieve(lds_guia.Object.plde_codigo[ll_Fila], lds_guia.Object.defe_plasag[ll_Fila])
		
		If ll_FilaD > 0 Then
			For ll_FilaD = 1 To dw_3.RowCount()
				ls_numsel = ls_numsel+''+dw_3.Object.sell_numero[ll_FilaD]+'-'
				ls_ubisel = ls_ubisel+''+dw_3.Object.sell_nombre[ll_FilaD]+'-'
			Next			
			ls_numsel = Mid(ls_numsel, 1,len(ls_numsel) -1 )
			ls_ubisel = Mid(ls_ubisel, 1,len(ls_ubisel) -1 )
		End If
		
	
	luo_Guia.of_SetPuertoDestino(lds_guia.Object.puer_nombre[ll_Fila])
	luo_Guia.of_SetNumeroSellos(ls_numsel)
//	luo_Guia.of_SetGlosaGD(em_observa.Text)
	luo_Guia.of_SetCantidadSellos(String(dw_3.RowCount()))
	luo_Guia.of_SetUbicacionSellos(ls_ubisel)
	
	If luo_Guia.of_EmiteGuia(lds_Guia.Object.clie_codigo[ll_Fila], lds_Guia.Object.plde_codigo[ll_Fila], lds_Guia.Object.defe_guides[ll_Fila], False, &
						1, 1, 1, 0, 0, 0, 1, 1, lds_guia.Object.defe_numero[ll_Fila])  > 0 Then
		luo_Guia.of_GeneraLibroGuia(1)
		luo_Guia.of_ActualizaEstadoGD(1, lds_Guia.Object.clie_codigo[ll_Fila], lds_Guia.Object.plde_codigo[ll_Fila], lds_Guia.Object.defe_guides[ll_Fila], 1, SQLCA)
	//	luo_Guia.of_RecuperaPDF(lds_guia.Object.defe_guides[ll_Fila], lds_guia.Object.defe_fecdes[1], 1)
	End If
		
	luo_Despacho.of_ActualizaEstado(1, lds_Guia.Object.clie_codigo[ll_Fila], lds_Guia.Object.plde_codigo[ll_Fila], lds_Guia.Object.defe_guides[ll_Fila], SQLCA)

Next 

Destroy luo_Guia
Destroy luo_Despacho
Destroy lds_guia
end event

type dw_embarcador from datawindow within w_info_guia_despacho_archivo_saam
boolean visible = false
integer x = 2578
integer y = 312
integer width = 192
integer height = 148
integer taborder = 40
boolean bringtotop = true
string title = "none"
string dataobject = "dw_info_archivoembarcadorguias"
borderstyle borderstyle = stylelowered!
end type

